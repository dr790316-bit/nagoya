<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nagoya Trip ☁️ (Firebase Sync)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f4f6f4',
                            100: '#e6e9e5',
                            200: '#ced6cc',
                            300: '#a5b29e',
                            400: '#889881',
                            500: '#6e7d67',
                            600: '#566351',
                        },
                        camel: {
                            50: '#fbf9f6',
                            100: '#f5f1eb',
                            200: '#eaddce',
                            300: '#c9b8a3',
                            400: '#b59f85',
                            500: '#9e866b',
                        },
                        washi: '#F8F7F4',
                        sumi: '#4A4A4A',
                        stone: '#8E8E8E',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(165, 178, 158, 0.15)',
                        'card': '0 4px 20px -4px rgba(0, 0, 0, 0.03)',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'bounce-in': 'bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8F7F4;
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation; 
            color: #4A4A4A;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            background: #F8F7F4;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 640px) {
            .app-container {
                min-height: 90vh;
                margin-top: 5vh;
                margin-bottom: 5vh;
                border-radius: 40px;
                height: 90vh;
                border: 8px solid #fff;
            }
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px) scale(0.95); }

        .timeline-line {
            background: linear-gradient(to bottom, #e6e9e5 0%, #e6e9e5 50%, transparent 100%);
        }
    </style>
</head>
<body>

<div id="app">
    <div class="app-container font-sans">
        
        <!-- Toast -->
        <transition name="toast">
            <div v-if="toast.show" class="fixed top-8 left-1/2 transform -translate-x-1/2 z-[100] bg-white/90 backdrop-blur-md text-sumi px-6 py-3 rounded-full shadow-soft flex items-center space-x-3 min-w-[200px] justify-center border border-sage-100">
                <i :class="toast.icon" class="text-sage-400 text-lg"></i>
                <span class="text-sm font-medium tracking-wide">{{ toast.message }}</span>
            </div>
        </transition>

        <!-- Confirm Modal -->
        <div v-if="confirmModal.show" class="absolute inset-0 bg-sumi/10 backdrop-blur-[2px] z-[90] flex items-center justify-center p-8">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-soft animate-bounce-in text-center">
                <div class="w-14 h-14 rounded-full bg-camel-50 text-camel-400 mx-auto flex items-center justify-center mb-5">
                    <i class="fa-solid fa-exclamation text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-sumi mb-2 tracking-wide">{{ confirmModal.title }}</h3>
                <p class="text-sm text-stone mb-8 leading-relaxed">{{ confirmModal.message }}</p>
                <div class="flex space-x-3">
                    <button @click="confirmModal.show = false" class="flex-1 py-3 rounded-2xl bg-stone/5 text-stone font-medium text-sm hover:bg-stone/10 transition duration-300">Cancel</button>
                    <button @click="confirmAction" class="flex-1 py-3 rounded-2xl bg-camel-300 text-white font-medium text-sm shadow-lg shadow-camel-200 hover:bg-camel-400 transition duration-300">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-washi/95 backdrop-blur-sm z-20 sticky top-0 pt-8 pb-2 px-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-light tracking-widest text-sage-600">NAGOYA</h1>
                    <p class="text-[10px] text-stone tracking-[0.15em] mt-1 font-medium">2025.12.30 - 2026.01.05 • 冬</p>
                </div>
            </div>

            <div class="flex justify-between items-center px-1">
                <nav class="flex space-x-4 mx-auto w-full justify-between max-w-[320px]">
                    <button @click="currentTab = 'traffic'" :class="currentTab === 'traffic' ? 'text-sage-500' : 'text-stone/60 hover:text-stone'" class="flex flex-col items-center transition-all duration-500 group relative py-2 px-2">
                        <i class="fa-solid fa-train-subway text-lg mb-2 transition-transform duration-300" :class="currentTab === 'traffic' ? '-translate-y-1' : ''"></i>
                        <span class="text-[9px] font-medium tracking-widest opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-1">交通</span>
                        <div v-if="currentTab === 'traffic'" class="absolute bottom-0 w-1 h-1 bg-sage-400 rounded-full"></div>
                    </button>
                    <button @click="currentTab = 'split'" :class="currentTab === 'split' ? 'text-sage-500' : 'text-stone/60 hover:text-stone'" class="flex flex-col items-center transition-all duration-500 group relative py-2 px-2">
                        <i class="fa-solid fa-yen-sign text-lg mb-2 transition-transform duration-300" :class="currentTab === 'split' ? '-translate-y-1' : ''"></i>
                        <span class="text-[9px] font-medium tracking-widest opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-1">分帳</span>
                        <div v-if="currentTab === 'split'" class="absolute bottom-0 w-1 h-1 bg-sage-400 rounded-full"></div>
                    </button>
                    <button @click="currentTab = 'map'" :class="currentTab === 'map' ? 'text-sage-500' : 'text-stone/60 hover:text-stone'" class="flex flex-col items-center transition-all duration-500 group relative py-2 px-2">
                        <i class="fa-regular fa-map text-lg mb-2 transition-transform duration-300" :class="currentTab === 'map' ? '-translate-y-1' : ''"></i>
                        <span class="text-[9px] font-medium tracking-widest opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-1">地圖</span>
                        <div v-if="currentTab === 'map'" class="absolute bottom-0 w-1 h-1 bg-sage-400 rounded-full"></div>
                    </button>
                    <button @click="currentTab = 'broadcast'" :class="currentTab === 'broadcast' ? 'text-sage-500' : 'text-stone/60 hover:text-stone'" class="flex flex-col items-center transition-all duration-500 group relative py-2 px-2">
                        <div class="relative">
                            <i class="fa-regular fa-comment-dots text-lg mb-2 transition-transform duration-300" :class="currentTab === 'broadcast' ? '-translate-y-1' : ''"></i>
                            <span v-if="messages.length > 0" class="absolute -top-1 -right-1 w-1.5 h-1.5 bg-camel-400 rounded-full border border-washi"></span>
                        </div>
                        <span class="text-[9px] font-medium tracking-widest opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-1">留言</span>
                        <div v-if="currentTab === 'broadcast'" class="absolute bottom-0 w-1 h-1 bg-sage-400 rounded-full"></div>
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative scroll-smooth px-6 pt-2">
            
            <!-- Tab: Traffic -->
            <div v-if="currentTab === 'traffic'" class="pb-32 animate-fade-in-up">
                <div class="sticky top-0 z-10 bg-washi/95 backdrop-blur-md pt-2 pb-6 -mx-6 px-6 mb-2">
                    <div class="flex space-x-3 overflow-x-auto no-scrollbar items-center py-1">
                        <button v-for="day in days" :key="day" @click="currentDay = day" 
                            class="flex flex-col items-center justify-center min-w-[3.5rem] h-14 rounded-2xl transition-all duration-300 group border"
                            :class="currentDay === day ? 'bg-sage-300 text-white border-sage-300 shadow-lg shadow-sage-200' : 'bg-white text-stone border-transparent hover:bg-white hover:shadow-sm'">
                            <span class="text-[9px] uppercase font-bold tracking-widest mb-0.5 opacity-80">Day</span>
                            <span class="text-lg font-medium leading-none">{{ day }}</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-0 relative">
                    <div v-if="filteredTraffic.length === 0" class="flex flex-col items-center justify-center py-20 text-stone/30">
                        <i class="fa-solid fa-train-subway text-4xl mb-4 opacity-30"></i>
                        <p class="font-light text-xs tracking-[0.2em]">NO SCHEDULE</p>
                    </div>
                    <div v-if="filteredTraffic.length > 0" class="absolute top-6 bottom-12 left-[4.5rem] w-[1px] timeline-line z-0"></div>
                    <div v-for="item in filteredTraffic" :key="item.id" class="relative z-10 mb-6 last:mb-0 group">
                        <div class="flex items-start">
                            <div class="w-[4.5rem] flex flex-col items-center pt-2 mr-4 flex-shrink-0 bg-washi z-10">
                                <span class="text-sm font-bold text-sage-600 tracking-wide font-mono">{{ item.time }}</span>
                                <span v-if="item.endTime" class="text-[10px] text-stone/60 font-mono mt-1">{{ item.endTime }}</span>
                                <div class="w-8 h-8 rounded-full bg-white border border-sage-100 text-sage-400 flex items-center justify-center text-sm shadow-sm mt-3 mb-2">
                                    <i :class="getTransportIcon(item.type)"></i>
                                </div>
                            </div>
                            <div class="flex-1 bg-white rounded-[24px] p-5 shadow-card hover:shadow-soft transition-all duration-300 border border-transparent hover:border-sage-100 relative overflow-hidden">
                                <div class="absolute -right-6 -top-6 w-20 h-20 bg-sage-50 rounded-full opacity-50 blur-xl pointer-events-none"></div>
                                <div class="flex justify-between items-start mb-2 relative">
                                    <div>
                                        <div class="text-[9px] text-camel-400 font-bold tracking-widest uppercase mb-1">Destination</div>
                                        <h3 class="text-lg font-medium text-sumi leading-snug">{{ item.destination }}</h3>
                                    </div>
                                    <div class="flex space-x-2 pl-2">
                                        <a v-if="item.url" :href="item.url" target="_blank" class="w-8 h-8 bg-sage-50 text-sage-500 rounded-full flex items-center justify-center hover:bg-sage-500 hover:text-white transition-colors">
                                            <i class="fa-solid fa-link text-xs"></i>
                                        </a>
                                        <a v-if="item.ticketUrl" :href="item.ticketUrl" target="_blank" class="w-8 h-8 bg-camel-50 text-camel-400 rounded-full flex items-center justify-center hover:bg-camel-400 hover:text-white transition-colors">
                                            <i class="fa-solid fa-ticket text-xs"></i>
                                        </a>
                                    </div>
                                </div>
                                <p v-if="item.description" class="text-xs text-stone leading-relaxed whitespace-pre-wrap relative z-10">{{ item.description }}</p>
                                <div class="flex justify-end space-x-3 mt-4 pt-3 border-t border-sage-50 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                                    <button @click="editTraffic(item)" class="text-xs text-stone hover:text-sage-500 transition-colors flex items-center"><i class="fa-solid fa-pen mr-1"></i> Edit</button>
                                    <button @click="askDelete('traffic', item.id)" class="text-xs text-stone hover:text-red-400 transition-colors flex items-center"><i class="fa-solid fa-trash-can mr-1"></i> Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openTrafficModal" class="fixed bottom-8 right-6 w-14 h-14 bg-sage-300 text-white rounded-2xl shadow-lg shadow-sage-200 flex items-center justify-center hover:scale-105 hover:bg-sage-400 transition duration-300 z-20">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
            </div>

            <!-- Tab: Split -->
            <div v-if="currentTab === 'split'" class="pb-32 animate-fade-in-up space-y-6 pt-2">
                <div class="flex justify-between items-center px-2">
                    <div class="text-[10px] text-stone tracking-widest font-bold uppercase">即時匯率參考</div>
                    <div class="flex items-center space-x-2 bg-white px-4 py-2 rounded-full shadow-sm border border-sage-50">
                        <span class="text-xs text-stone">JPY 1 = TWD</span>
                        <input v-model.number="exchangeRate" type="number" step="0.001" class="w-14 text-right font-bold text-sage-600 bg-transparent border-b border-dotted border-sage-300 focus:outline-none text-sm pb-0.5">
                    </div>
                </div>
                <div class="bg-gradient-to-br from-sage-300 to-sage-400 rounded-[32px] p-8 text-white shadow-lg shadow-sage-200 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                    <h2 class="text-[10px] tracking-[0.2em] opacity-70 mb-2 uppercase">總計花費金額</h2>
                    <div class="flex items-baseline space-x-2">
                        <span class="text-lg opacity-70 font-light">NT$</span>
                        <span class="text-5xl font-light tracking-tight">{{ Math.round(totalExpense).toLocaleString() }}</span>
                    </div>
                    <div class="mt-8 bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/10">
                        <p v-if="debts.length === 0" class="text-center text-xs opacity-80 py-2 tracking-wider">All settled ✨</p>
                        <div v-else class="space-y-3">
                            <div v-for="debt in debts" :key="debt.text" class="flex justify-between items-center text-xs border-b border-white/10 pb-2 last:border-0 last:pb-0">
                                <div class="flex items-center space-x-3">
                                    <span class="font-bold bg-white/20 px-2 py-1 rounded">{{ debt.from }}</span>
                                    <i class="fa-solid fa-arrow-right-long opacity-60 text-[10px]"></i>
                                    <span class="font-bold bg-white/20 px-2 py-1 rounded">{{ debt.to }}</span>
                                </div>
                                <span class="font-medium tracking-wide">NT$ {{ Math.round(debt.amount).toLocaleString() }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-[32px] p-6 shadow-card border border-transparent relative overflow-hidden">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="font-medium text-sumi tracking-wide">新增支出</h3>
                        <div class="flex bg-washi rounded-xl p-1">
                            <button @click="currencyMode = 'JPY'" :class="currencyMode === 'JPY' ? 'bg-white text-sage-600 shadow-sm' : 'text-stone'" class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all">JPY</button>
                            <button @click="currencyMode = 'TWD'" :class="currencyMode === 'TWD' ? 'bg-white text-sage-600 shadow-sm' : 'text-stone'" class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all">TWD</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <input v-model="newExpense.description" placeholder="項目名稱..." class="w-full bg-washi border-none rounded-2xl p-4 text-sm text-sumi placeholder-stone/50 focus:ring-2 focus:ring-sage-100 outline-none transition">
                        <div class="flex space-x-3 relative">
                            <div class="flex-1 relative">
                                <span class="absolute left-4 top-4 text-stone/50 text-sm font-bold">{{ currencyMode === 'JPY' ? '¥' : '$' }}</span>
                                <input v-model.number="newExpense.inputAmount" type="number" placeholder="0" class="w-full pl-8 bg-washi border-none rounded-2xl p-4 text-sm text-sumi placeholder-stone/50 focus:ring-2 focus:ring-sage-100 outline-none transition font-mono">
                            </div>
                            <div class="flex items-center justify-center px-4 bg-washi rounded-2xl min-w-[90px]">
                                <div class="text-right">
                                    <div class="text-[9px] text-stone uppercase tracking-wide">匯率試算</div>
                                    <div class="text-xs text-sumi font-bold">NT$ {{ calculatedTWD.toLocaleString() }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-2">
                            <label class="text-[10px] text-stone tracking-widest uppercase block mb-3 ml-1">付款人</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button v-for="member in members" :key="member" @click="newExpense.payer = member" :class="newExpense.payer === member ? 'bg-sage-300 text-white shadow-md shadow-sage-100' : 'bg-washi text-stone hover:bg-sage-50'" class="py-2.5 rounded-xl text-xs transition-all duration-300 truncate font-medium">{{ member }}</button>
                            </div>
                        </div>
                        <button @click="addExpense" class="w-full mt-2 bg-stone/5 text-sumi py-4 rounded-2xl text-sm font-medium hover:bg-sage-300 hover:text-white hover:shadow-lg hover:shadow-sage-100 transition duration-300 flex items-center justify-center"><i class="fa-solid fa-plus mr-2"></i> 新增一筆</button>
                    </div>
                </div>
                <div class="bg-white rounded-[32px] p-6 shadow-card">
                    <h3 class="text-xs font-bold text-stone tracking-widest uppercase mb-4 pl-2 border-l-2 border-camel-300">個人支出明細</h3>
                    <div class="grid grid-cols-4 gap-2 mb-6">
                        <button v-for="m in members" :key="m" @click="selectedPayerForDetail = m" :class="selectedPayerForDetail === m ? 'bg-camel-300 text-white shadow-md shadow-camel-100' : 'bg-washi text-stone hover:bg-camel-50'" class="px-1 py-2.5 rounded-xl text-xs transition-all font-medium truncate">{{ m }}</button>
                    </div>
                    <div v-if="selectedPayerForDetail" class="bg-washi/50 rounded-2xl p-4">
                        <div v-if="payerExpenses.length === 0" class="text-center text-stone/40 text-xs py-8">No records found</div>
                        <div v-else class="space-y-3 max-h-60 overflow-y-auto pr-2 scrollbar-thin">
                            <div v-for="(exp, index) in payerExpenses" :key="index" class="flex justify-between items-center text-sm group">
                                <div class="flex-1 min-w-0 mr-4">
                                    <div class="text-sumi truncate text-xs font-medium">{{ exp.description }}</div>
                                    <div class="text-[9px] text-stone mt-0.5">{{ exp.date }}</div>
                                </div>
                                <div class="font-mono text-sage-600 text-xs">NT$ {{ Math.round(exp.amount).toLocaleString() }}</div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-dashed border-stone/20 flex justify-between items-center">
                            <span class="text-[10px] text-stone font-bold tracking-widest uppercase">Total</span>
                            <span class="text-lg font-medium text-sumi font-mono">NT$ {{ Math.round(payerTotal).toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                 <div class="space-y-3">
                    <h3 class="text-[10px] text-stone tracking-widest uppercase pl-4 mb-1">支出紀錄列表</h3>
                    <div v-for="(exp, index) in expenses.slice().reverse().slice(0, 5)" :key="index" class="bg-white px-5 py-4 rounded-2xl flex justify-between items-center group border border-transparent hover:border-sage-50 shadow-sm">
                        <div class="flex items-center space-x-4 overflow-hidden">
                            <div class="w-9 h-9 rounded-full bg-sage-50 text-sage-500 flex items-center justify-center text-xs font-bold">{{ exp.payer.substring(0,1) }}</div>
                            <div class="min-w-0">
                                <p class="text-sumi text-sm truncate font-medium">{{ exp.description }}</p>
                                <p class="text-[10px] text-stone mt-0.5">{{ exp.date }}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="text-sm font-bold text-sumi font-mono">NT$ {{ Math.round(exp.amount).toLocaleString() }}</div>
                            <button @click="askDelete('expense', expenses.length - 1 - index)" class="text-xs text-stone hover:text-red-400 mt-1 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Map -->
            <div v-if="currentTab === 'map'" class="pb-32 animate-fade-in-up space-y-6 pt-2">
                <div>
                    <div class="flex justify-between items-end px-2 mb-3">
                         <h3 class="text-[10px] text-stone tracking-widest uppercase font-bold">常用位置地圖</h3>
                    </div>
                    <div class="space-y-3">
                         <div v-if="locations.length === 0" class="text-center py-8 text-stone/40 text-xs">尚無常用位置</div>
                        <div v-for="loc in locations" :key="loc.id" class="bg-white rounded-[24px] p-5 shadow-card hover:shadow-soft transition-all duration-300 group relative">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fa-solid fa-location-dot text-sage-400"></i>
                                        <h4 class="text-lg font-medium text-sumi">{{ loc.name }}</h4>
                                    </div>
                                    <p class="text-xs text-stone pl-6 mb-3">{{ loc.description }}</p>
                                    <a v-if="loc.url" :href="loc.url" target="_blank" class="inline-flex items-center space-x-1 text-[10px] font-bold text-camel-400 bg-camel-50 px-3 py-1.5 rounded-full hover:bg-camel-400 hover:text-white transition-colors ml-6">
                                        <i class="fa-solid fa-map-location-dot"></i><span>Google Maps</span>
                                    </a>
                                </div>
                                <div class="flex flex-col space-y-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                     <button @click="editLocation(loc)" class="w-8 h-8 rounded-full bg-washi text-stone hover:text-sage-500 flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button>
                                     <button @click="askDelete('location', loc.id)" class="w-8 h-8 rounded-full bg-washi text-stone hover:text-red-400 flex items-center justify-center"><i class="fa-solid fa-trash-can text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center mt-6">
                        <button @click="openLocationModal" class="w-14 h-14 rounded-full bg-white border-2 border-dashed border-sage-200 text-sage-400 flex items-center justify-center hover:bg-sage-50 hover:border-sage-300 hover:text-sage-500 transition-all duration-300 shadow-sm group">
                            <i class="fa-solid fa-plus text-xl group-hover:scale-110 transition-transform"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-[32px] p-6 shadow-card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-[10px] text-stone tracking-widest uppercase font-bold border-l-2 border-sage-300 pl-2">未來一周天氣</h3>
                        <select v-model="weatherCity" @change="fetchWeather" class="text-xs font-bold text-sage-600 bg-sage-50 border-none rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-sage-200 outline-none cursor-pointer">
                            <option value="Nagoya">名古屋</option>
                            <option value="Nagano">長野</option>
                            <option value="Kanazawa">金澤</option>
                            <option value="Takayama">高山</option>
                            <option value="Matsumoto">松本</option>
                            <option value="Shirakawa">合掌村</option>
                        </select>
                    </div>
                    <div v-if="!weatherData.daily" class="text-center py-8 text-stone/40">
                         <i class="fa-solid fa-spinner fa-spin mb-2"></i>
                         <p class="text-xs">Loading Weather...</p>
                    </div>
                    <div v-else class="flex overflow-x-auto no-scrollbar space-x-4 pb-2">
                        <div v-for="(day, index) in 7" :key="index" class="flex-shrink-0 flex flex-col items-center min-w-[4rem] bg-washi rounded-2xl py-3 px-1">
                            <span class="text-[10px] text-stone font-bold uppercase mb-1">{{ getWeatherDay(index) }}</span>
                            <span class="text-[9px] text-stone/50 mb-2">{{ getWeatherDate(index) }}</span>
                            <i :class="getWeatherIcon(weatherData.daily.weathercode[index])" class="text-xl text-sage-400 mb-2"></i>
                            <div class="flex flex-col items-center text-[10px] font-mono font-medium text-sumi">
                                <span>{{ Math.round(weatherData.daily.temperature_2m_max[index]) }}°</span>
                                <span class="w-4 h-[1px] bg-stone/20 my-0.5"></span>
                                <span class="text-stone">{{ Math.round(weatherData.daily.temperature_2m_min[index]) }}°</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Broadcast -->
            <div v-if="currentTab === 'broadcast'" class="h-full flex flex-col pb-4 animate-fade-in-up">
                <div class="flex-1 overflow-y-auto space-y-6 pb-4 pt-2 px-2" ref="msgContainer">
                    <div v-if="messages.length === 0" class="text-center py-32 opacity-30">
                        <i class="fa-regular fa-comments text-4xl mb-4 text-stone"></i>
                        <p class="text-xs text-stone tracking-widest">START CONVERSATION</p>
                    </div>
                    <div v-for="msg in messages" :key="msg.id" class="flex flex-col items-start group">
                        <div class="flex items-end space-x-3 max-w-[90%]">
                            <div class="w-8 h-8 rounded-2xl bg-white border border-sage-100 text-sage-500 flex items-center justify-center text-[10px] font-bold flex-shrink-0 shadow-sm mb-1">{{ msg.user.substring(0,1) }}</div>
                            <div>
                                <span class="text-[9px] text-stone ml-2 mb-1 block tracking-wide">{{ msg.user }}</span>
                                <div class="bg-white px-5 py-3 rounded-2xl rounded-tl-none shadow-card text-sm text-sumi relative leading-relaxed">
                                    {{ msg.text }}
                                    <div class="text-[9px] text-stone/50 text-right mt-1 font-mono">{{ msg.time }}</div>
                                    <button @click="askDelete('message', msg.id)" class="absolute -top-2 -right-2 bg-washi text-stone hover:text-red-400 rounded-full w-5 h-5 hidden group-hover:flex items-center justify-center text-[10px] shadow-sm border border-stone/10"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 pb-8 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] rounded-t-[32px] border-t border-sage-50">
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <button v-for="m in members" :key="m" @click="msgUser = m" :class="msgUser === m ? 'bg-sage-300 text-white shadow-md shadow-sage-100' : 'bg-washi text-stone hover:bg-sage-50'" class="py-2 rounded-xl text-[10px] font-medium transition-all duration-200 truncate">{{ m }}</button>
                    </div>
                    <div class="flex items-center bg-washi rounded-2xl px-2 py-2 border border-transparent focus-within:border-sage-100 focus-within:bg-white transition-all duration-300">
                        <input v-model="msgText" placeholder="Write a message..." class="flex-1 bg-transparent border-none outline-none text-sm text-sumi placeholder-stone/50 px-3" @keyup.enter="sendMessage">
                        <button @click="sendMessage" class="w-10 h-10 bg-sage-300 text-white rounded-xl hover:bg-sage-400 hover:shadow-lg hover:shadow-sage-200 transition flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Modals -->
        <div v-if="showTrafficModal" class="absolute inset-0 bg-sumi/10 backdrop-blur-[2px] z-50 flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:w-[400px] sm:rounded-[32px] rounded-t-[32px] p-8 shadow-2xl animate-fade-in-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-lg font-bold text-sumi tracking-wide">{{ isEditingTraffic ? 'Edit Transport' : 'Add Transport' }}</h3>
                    <button @click="showTrafficModal = false" class="w-8 h-8 rounded-full bg-washi text-stone hover:bg-stone/10 flex items-center justify-center transition"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="text-[10px] font-bold text-stone tracking-widest block mb-3">TYPE</label>
                        <div class="grid grid-cols-5 gap-2">
                            <button v-for="t in ['plane', 'train', 'bus', 'taxi', 'walk']" :key="t" @click="trafficModalData.type = t" :class="trafficModalData.type === t ? 'bg-sage-300 text-white shadow-md shadow-sage-200' : 'bg-washi text-stone hover:bg-sage-50'" class="p-3 rounded-2xl flex justify-center items-center transition-all duration-300 aspect-square"><i :class="getTransportIcon(t)" class="text-lg"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">START</label><input v-model="trafficModalData.time" type="time" class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi font-mono"></div>
                        <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">END</label><input v-model="trafficModalData.endTime" type="time" class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi font-mono"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">DESTINATION</label><input v-model="trafficModalData.destination" type="text" placeholder="e.g. Nagoya Station" class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi placeholder-stone/40"></div>
                    <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">NOTE</label><textarea v-model="trafficModalData.description" placeholder="Details..." class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi placeholder-stone/40 h-24 resize-none"></textarea></div>
                    <div class="grid grid-cols-1 gap-3">
                         <div class="relative"><i class="fa-solid fa-link absolute left-4 top-4 text-stone/40 text-xs"></i><input v-model="trafficModalData.url" type="text" placeholder="Info Link" class="w-full bg-washi rounded-2xl p-4 pl-10 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sage-600 placeholder-stone/40"></div>
                         <div class="relative"><i class="fa-solid fa-ticket absolute left-4 top-4 text-stone/40 text-xs"></i><input v-model="trafficModalData.ticketUrl" type="text" placeholder="Ticket Link" class="w-full bg-washi rounded-2xl p-4 pl-10 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-camel-500 placeholder-stone/40"></div>
                    </div>
                    <button @click="saveTraffic" class="w-full py-4 rounded-2xl bg-sage-300 text-white font-medium shadow-lg shadow-sage-200 hover:bg-sage-400 transition duration-300 mt-2">Save Schedule</button>
                </div>
            </div>
        </div>
        
        <div v-if="showLocationModal" class="absolute inset-0 bg-sumi/10 backdrop-blur-[2px] z-50 flex items-end sm:items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl animate-fade-in-up">
                 <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-sumi tracking-wide">{{ isEditingLocation ? 'Edit Location' : 'Add Location' }}</h3>
                    <button @click="showLocationModal = false" class="w-8 h-8 rounded-full bg-washi text-stone hover:bg-stone/10 flex items-center justify-center transition"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="space-y-4">
                    <input v-model="locationModalData.name" type="text" placeholder="地點名稱 (Name)" class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi">
                    <input v-model="locationModalData.description" type="text" placeholder="地點描述 (Desc)" class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi">
                    <input v-model="locationModalData.url" type="text" placeholder="Google Maps URL" class="w-full bg-washi rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-sage-100 text-sumi">
                    <button @click="saveLocation" class="w-full py-3 rounded-2xl bg-sage-300 text-white font-medium shadow-lg shadow-sage-200 hover:bg-sage-400 transition duration-300 mt-2">Save</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
// 1. Import Firebase Modules
// FIX: Renamed 'ref' to 'dbRef' to avoid conflict with Vue's ref
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref as dbRef, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

// 2. Firebase Configuration (USER TO REPLACE)
const firebaseConfig = {apiKey: "AIzaSyDRtLqLIPtLB7WmGqwbS4YjRHpDRF8Rv0g",
  authDomain: "nagoya-snow-tour.firebaseapp.com",
  databaseURL: "https://nagoya-snow-tour-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nagoya-snow-tour",
  storageBucket: "nagoya-snow-tour.firebasestorage.app",
  messagingSenderId: "189759409360",
  appId: "1:189759409360:web:26ef01e7ae294a1222a2d5",
  measurementId: "G-PS3ZL41FYT"
};

// 3. Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Get Vue from global (loaded via script tag)
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        const currentTab = ref('traffic');
        const currentDay = ref(1);
        const days = ref([1, 2, 3, 4, 5, 6, 7]); 
        const showTrafficModal = ref(false);
        const isEditingTraffic = ref(false);
        const editingTrafficId = ref(null);
        const toast = ref({ show: false, message: '', icon: '' });
        const confirmModal = ref({ show: false, title: '', message: '', targetId: null, targetType: '' });
        const fixedMembers = ['明學', '嘉旺', '郡哲', '柏翰', '聿玄', '常駐', '厚仁', '婉瑜'];
        
        // Default Data (Will be uploaded if DB is empty)
        const defaultTraffic = [
            // Day 1
            { id: 1, day: 1, type: 'plane', time: '02:55', endTime: '06:25', destination: 'TPE → NGO', description: '航班前往名古屋', url: '', ticketUrl: '' },
            { id: 2, day: 1, type: 'taxi', time: '07:30', endTime: '10:30', destination: '機場 → 合掌村', description: '包車接送', url: '', ticketUrl: '' },
            { id: 3, day: 1, type: 'walk', time: '10:30', endTime: '16:00', destination: '合掌村', description: '散策漫步', url: '', ticketUrl: '' },
            { id: 4, day: 1, type: 'bus', time: '16:00', endTime: '17:30', destination: '白川 → 金澤', description: '搭車移動', url: '', ticketUrl: '' },
            { id: 5, day: 1, type: 'walk', time: '17:30', endTime: '18:00', destination: '東急stay金澤飯店', description: '飯店 Check-in', url: '', ticketUrl: '' },
            { id: 6, day: 1, type: 'walk', time: '18:00', endTime: '21:00', destination: '香林坊', description: '逛街晚餐', url: '', ticketUrl: '' },

            // Day 2
            { id: 7, day: 2, type: 'walk', time: '09:00', endTime: '11:00', destination: '兼六園', description: '日本三大名園', url: '', ticketUrl: '' },
            { id: 8, day: 2, type: 'walk', time: '11:00', endTime: '13:00', destination: '近江町市場', description: '仙桃餐廳(已預約)', url: '', ticketUrl: '' },
            { id: 9, day: 2, type: 'walk', time: '13:00', endTime: '17:00', destination: '車站商圈/茶屋街', description: '東茶屋街散策', url: '', ticketUrl: '' },
            { id: 10, day: 2, type: 'walk', time: '18:00', endTime: '19:00', destination: '一風堂', description: '金澤香林坊店', url: '', ticketUrl: '' },
            { id: 11, day: 2, type: 'walk', time: '19:00', endTime: '21:00', destination: '香林坊', description: '夜間散策', url: '', ticketUrl: '' },
            { id: 12, day: 2, type: 'walk', time: '22:00', endTime: '23:00', destination: '金澤城', description: '夜訪', url: '', ticketUrl: '' },
            { id: 13, day: 2, type: 'walk', time: '00:00', endTime: '01:00', destination: '尾山神社', description: '初詣參拜', url: '', ticketUrl: '' },

            // Day 3
            { id: 14, day: 3, type: 'train', time: '10:05', endTime: '11:10', destination: '金澤 → 長野', description: '新幹線 (Klook訂票)', url: '', ticketUrl: '' },
            { id: 15, day: 3, type: 'walk', time: '13:00', endTime: '14:00', destination: '午餐', description: '北野家そば 横沢支店', url: '', ticketUrl: '' },
            { id: 16, day: 3, type: 'walk', time: '15:00', endTime: '18:00', destination: '善光寺', description: '散策參拜', url: '', ticketUrl: '' },
            { id: 17, day: 3, type: 'walk', time: '19:00', endTime: '21:00', destination: '裾花峽溫泉/唐吉訶德', description: '溫泉與購物', url: '', ticketUrl: '' },

            // Day 4
            { id: 18, day: 4, type: 'bus', time: '08:20', endTime: '09:24', destination: '長野 → 戶隱', description: '巴士移動', url: '', ticketUrl: '' },
            { id: 19, day: 4, type: 'walk', time: '09:30', endTime: '14:20', destination: '戶隱神社', description: '雪地健走/午餐蕎麥麵', url: '', ticketUrl: '' },
            { id: 20, day: 4, type: 'bus', time: '14:20', endTime: '15:38', destination: '戶隱 → 長野', description: '巴士移動', url: '', ticketUrl: '' },
            { id: 21, day: 4, type: 'train', time: '17:00', endTime: '17:53', destination: '長野 → 松本', description: 'JR移動', url: '', ticketUrl: '' },
            { id: 22, day: 4, type: 'walk', time: '18:00', endTime: '19:30', destination: '晚餐', description: '汁なし坦々麺 THREE P\'S', url: '', ticketUrl: '' },
            { id: 23, day: 4, type: 'walk', time: '20:00', endTime: '21:00', destination: '松本城', description: '光影秀', url: '', ticketUrl: '' },

            // Day 5
            { id: 24, day: 5, type: 'bus', time: '07:40', endTime: '09:08', destination: '松本 → 平湯', description: '巴士移動', url: '', ticketUrl: '' },
            { id: 25, day: 5, type: 'bus', time: '09:40', endTime: '10:12', destination: '平湯 → 新穗高', description: '巴士移動', url: '', ticketUrl: '' },
            { id: 26, day: 5, type: 'walk', time: '10:12', endTime: '16:00', destination: '新穗高纜車', description: '賞雪景', url: '', ticketUrl: '' },
            { id: 27, day: 5, type: 'bus', time: '16:00', endTime: '17:00', destination: '新穗高 → 平湯', description: '巴士移動', url: '', ticketUrl: '' },
            { id: 28, day: 5, type: 'walk', time: '17:00', endTime: '21:00', destination: 'Hirayunomori Annex', description: '晚餐/泡湯/休息', url: '', ticketUrl: '' },

            // Day 6
            { id: 29, day: 6, type: 'walk', time: '08:00', endTime: '16:30', destination: '上高地', description: '雪地健行 (約8小時)', url: '', ticketUrl: '' },
            { id: 30, day: 6, type: 'bus', time: '17:30', endTime: '18:31', destination: '平湯 → 高山', description: '巴士移動', url: '', ticketUrl: '' },
            { id: 31, day: 6, type: 'bus', time: '19:00', endTime: '21:45', destination: '高山 → 名古屋', description: '移動', url: '', ticketUrl: '' },
            { id: 32, day: 6, type: 'walk', time: '23:00', endTime: '00:00', destination: '熱田神宮', description: '初惠比壽參拜', url: '', ticketUrl: '' },

            // Day 7
            { id: 33, day: 7, type: 'walk', time: '10:00', endTime: '12:00', destination: '名古屋城', description: '參觀', url: '', ticketUrl: '' },
            { id: 34, day: 7, type: 'walk', time: '13:00', endTime: '15:00', destination: '大須觀音寺', description: '商店街逛街', url: '', ticketUrl: '' },
            { id: 35, day: 7, type: 'plane', time: '19:40', endTime: '22:35', destination: 'NGO → KHH', description: '高雄賦歸', url: '', ticketUrl: '' },
            { id: 36, day: 7, type: 'plane', time: '22:45', endTime: '01:25', destination: 'NGO → TPE', description: '台北賦歸', url: '', ticketUrl: '' }
        ];

        const defaultLocations = [
            { id: 1, name: '長野車站', description: '新幹線搭乘', url: 'https://maps.app.goo.gl/nagano-station' }
        ];

        const cityCoords = {
            'Nagoya': { lat: 35.1815, lon: 136.9066 },
            'Nagano': { lat: 36.6485, lon: 138.1942 },
            'Kanazawa': { lat: 36.5613, lon: 136.6562 },
            'Takayama': { lat: 36.1407, lon: 137.2595 },
            'Matsumoto': { lat: 36.2380, lon: 137.9685 },
            'Shirakawa': { lat: 36.2566, lon: 136.9043 },
        };

        // Reactive State
        const trafficList = ref([]);
        const members = ref([...fixedMembers]);
        const expenses = ref([]);
        const messages = ref([]);
        const locations = ref([]);
        const exchangeRate = ref(0.215); 
        
        const currencyMode = ref('JPY'); 
        const weatherCity = ref('Nagoya');
        const weatherData = ref({});

        const newExpense = ref({ description: '', inputAmount: '', payer: '' });
        const trafficModalData = ref({ time: '09:00', endTime: '', type: 'train', destination: '', description: '', url: '', ticketUrl: '' }); 
        const msgText = ref('');
        const msgUser = ref(fixedMembers[0]);
        const msgContainer = ref(null);
        const selectedPayerForDetail = ref(fixedMembers[0]);

        const locationModalData = ref({ name: '', description: '', url: '' });
        const showLocationModal = ref(false);
        const isEditingLocation = ref(false);
        const editingLocationId = ref(null);

        const showToast = (msg, type = 'success') => {
            toast.value = { show: true, message: msg, icon: type === 'error' ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-check' };
            setTimeout(() => { toast.value.show = false; }, 3000);
        };

        // 4. Setup Realtime Listeners (onMounted)
        onMounted(() => {
            // Traffic Listener
            onValue(dbRef(db, 'traffic'), (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    // Firebase stores arrays with integer keys if sparse, or just arrays.
                    // Object.values handles both object-map and array formats.
                    // We check if it's array or object
                    trafficList.value = Array.isArray(val) ? val : Object.values(val);
                } else {
                    // Init DB with defaults if empty
                    trafficList.value = defaultTraffic;
                    set(dbRef(db, 'traffic'), defaultTraffic);
                }
            });

            // Expenses Listener
            onValue(dbRef(db, 'expenses'), (snapshot) => {
                const val = snapshot.val();
                expenses.value = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
            });

            // Messages Listener
            onValue(dbRef(db, 'messages'), (snapshot) => {
                const val = snapshot.val();
                messages.value = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
            });

            // Locations Listener
            onValue(dbRef(db, 'locations'), (snapshot) => {
                const val = snapshot.val();
                if (val) {
                     locations.value = Array.isArray(val) ? val : Object.values(val);
                } else {
                    locations.value = defaultLocations;
                    set(dbRef(db, 'locations'), defaultLocations);
                }
            });

            // Exchange Rate Listener
            onValue(dbRef(db, 'exchangeRate'), (snapshot) => {
                const val = snapshot.val();
                if(val) exchangeRate.value = parseFloat(val);
            });

            fetchWeather();
        });

        // 5. Sync Watchers (Write to Firebase)
        // Note: This simplest approach overwrites the node when local data changes.
        // For high-concurrency apps, consider individual push/update actions instead.
        watch(trafficList, (val) => {
            set(dbRef(db, 'traffic'), val);
        }, { deep: true });

        watch(expenses, (val) => {
            set(dbRef(db, 'expenses'), val);
        }, { deep: true });

        watch(messages, (val) => {
            set(dbRef(db, 'messages'), val);
        }, { deep: true });

        watch(locations, (val) => {
            set(dbRef(db, 'locations'), val);
        }, { deep: true });

        watch(exchangeRate, (val) => {
            set(dbRef(db, 'exchangeRate'), val);
        });

        // Computed
        const filteredTraffic = computed(() => {
            return trafficList.value.filter(item => item.day === currentDay.value).sort((a, b) => a.time.localeCompare(b.time));
        });
        const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
        const calculatedTWD = computed(() => {
            if (!newExpense.value.inputAmount) return 0;
            return currencyMode.value === 'JPY' ? Math.round(newExpense.value.inputAmount * exchangeRate.value) : Math.round(newExpense.value.inputAmount);
        });
        const debts = computed(() => {
            if (members.value.length === 0) return [];
            let paid = {};
            members.value.forEach(m => paid[m] = 0);
            expenses.value.forEach(e => { if (paid[e.payer] !== undefined) paid[e.payer] += e.amount; });
            const perPerson = totalExpense.value / members.value.length;
            let balance = members.value.map(m => ({ name: m, val: paid[m] - perPerson }));
            let result = [];
            balance.sort((a, b) => a.val - b.val); 
            let i = 0, j = balance.length - 1; 
            while (i < j) {
                let debtor = balance[i];
                let creditor = balance[j];
                if (Math.abs(debtor.val) < 1) { i++; continue; }
                if (Math.abs(creditor.val) < 1) { j--; continue; }
                let amount = Math.min(Math.abs(debtor.val), creditor.val);
                if (amount > 1) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                debtor.val += amount; creditor.val -= amount;
                if (Math.abs(debtor.val) < 1) i++; if (creditor.val < 1) j--;
            }
            return result;
        });
        const payerExpenses = computed(() => {
            if (!selectedPayerForDetail.value) return [];
            return expenses.value.filter(e => e.payer === selectedPayerForDetail.value).slice().reverse();
        });
        const payerTotal = computed(() => {
            return payerExpenses.value.reduce((sum, item) => sum + item.amount, 0);
        });

        // Actions
        const askDelete = (type, id) => {
            confirmModal.value = { show: true, title: 'Delete Item?', message: 'Are you sure?', targetId: id, targetType: type };
        };
        
        // Modified to clear Database instead of localStorage
        const askReset = () => {
             confirmModal.value = { show: true, title: 'Clear Database?', message: 'All data will be deleted from Firebase.', targetId: null, targetType: 'reset' };
        };
        
        const confirmAction = () => {
            const { targetType, targetId } = confirmModal.value;
            if (targetType === 'traffic') {
                trafficList.value = trafficList.value.filter(x => x.id !== targetId);
                showToast('Traffic item deleted');
            } else if (targetType === 'expense') {
                // expenses uses index based logic in UI, but we sync whole array.
                expenses.value.splice(targetId, 1);
                showToast('Expense record removed');
            } else if (targetType === 'message') {
                messages.value = messages.value.filter(m => m.id !== targetId);
                showToast('Message deleted');
            } else if (targetType === 'location') {
                locations.value = locations.value.filter(l => l.id !== targetId);
                showToast('Location removed');
            } else if (targetType === 'reset') {
                // Clear DB
                set(dbRef(db), null);
                showToast('Database Cleared');
                // Reload to trigger init defaults
                setTimeout(() => location.reload(), 1000);
            }
            confirmModal.value.show = false;
        };
        
        const openTrafficModal = () => { isEditingTraffic.value = false; editingTrafficId.value = null; trafficModalData.value = { time: '09:00', endTime: '', type: 'train', destination: '', description: '', url: '', ticketUrl: '' }; showTrafficModal.value = true; };
        const editTraffic = (item) => { isEditingTraffic.value = true; editingTrafficId.value = item.id; trafficModalData.value = { ...item }; showTrafficModal.value = true; };
        const saveTraffic = () => {
            if (!trafficModalData.value.destination) { showToast('Please enter destination', 'error'); return; }
            if (isEditingTraffic.value) {
                const idx = trafficList.value.findIndex(x => x.id === editingTrafficId.value);
                if (idx !== -1) { trafficList.value[idx] = { ...trafficModalData.value, id: editingTrafficId.value, day: currentDay.value }; showToast('Transport updated'); }
            } else {
                trafficList.value.push({ id: Date.now(), day: currentDay.value, ...trafficModalData.value });
                showToast('Transport added');
            }
            showTrafficModal.value = false;
        };
        const getTransportIcon = (type) => {
            switch(type) {
                case 'plane': return 'fa-solid fa-plane';
                case 'train': return 'fa-solid fa-train';
                case 'bus': return 'fa-solid fa-bus';
                case 'taxi': return 'fa-solid fa-taxi';
                case 'walk': return 'fa-solid fa-person-walking'; 
                default: return 'fa-solid fa-diamond-turn-right';
            }
        };

        const addExpense = () => {
            if (!newExpense.value.description || !newExpense.value.inputAmount || !newExpense.value.payer) { showToast('Missing info', 'error'); return; }
            expenses.value.push({ description: newExpense.value.description, originalAmount: newExpense.value.inputAmount, originalCurrency: currencyMode.value, amount: calculatedTWD.value, payer: newExpense.value.payer, date: new Date().toLocaleDateString() });
            newExpense.value.description = ''; newExpense.value.inputAmount = '';
            showToast('Expense added');
        };
        
        const sendMessage = () => {
            if (!msgText.value.trim()) return;
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            messages.value.push({ id: Date.now(), user: msgUser.value, text: msgText.value, time: timeString });
            msgText.value = '';
            nextTick(() => { if (msgContainer.value) msgContainer.value.scrollTop = msgContainer.value.scrollHeight; });
        };

        const openLocationModal = () => { isEditingLocation.value = false; locationModalData.value = { name: '', description: '', url: '' }; showLocationModal.value = true; };
        const editLocation = (loc) => { isEditingLocation.value = true; editingLocationId.value = loc.id; locationModalData.value = { ...loc }; showLocationModal.value = true; };
        const saveLocation = () => {
            if(!locationModalData.value.name) { showToast('Name required', 'error'); return; }
            if(isEditingLocation.value) {
                const idx = locations.value.findIndex(l => l.id === editingLocationId.value);
                if(idx !== -1) locations.value[idx] = { ...locationModalData.value, id: editingLocationId.value };
            } else {
                locations.value.push({ id: Date.now(), ...locationModalData.value });
            }
            showLocationModal.value = false;
            showToast('Location saved');
        };

        const fetchWeather = async () => {
            const coords = cityCoords[weatherCity.value];
            if(!coords) return;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`);
                weatherData.value = await res.json();
            } catch(e) { console.error(e); }
        };
        const getWeatherDay = (idx) => { const d = new Date(); d.setDate(d.getDate() + idx); return ['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()]; };
        const getWeatherDate = (idx) => { const d = new Date(); d.setDate(d.getDate() + idx); return `${d.getMonth()+1}/${d.getDate()}`; };
        const getWeatherIcon = (code) => { if(code === 0) return 'fa-solid fa-sun'; if(code <= 3) return 'fa-solid fa-cloud-sun'; if(code <= 48) return 'fa-solid fa-smog'; if(code <= 67) return 'fa-solid fa-cloud-rain'; if(code <= 77) return 'fa-regular fa-snowflake'; return 'fa-solid fa-cloud'; };

        return {
            currentTab, currentDay, days,
            members, expenses, newExpense, totalExpense, debts, addExpense,
            messages, msgText, msgUser, sendMessage, msgContainer,
            askDelete, askReset,
            exchangeRate, currencyMode, calculatedTWD,
            trafficList, filteredTraffic, showTrafficModal, trafficModalData, openTrafficModal, saveTraffic, editTraffic, getTransportIcon, isEditingTraffic,
            toast, confirmModal, confirmAction,
            selectedPayerForDetail, payerExpenses, payerTotal,
            locations, showLocationModal, locationModalData, openLocationModal, editLocation, saveLocation, isEditingLocation,
            weatherCity, weatherData, fetchWeather, getWeatherDay, getWeatherDate, getWeatherIcon
        };
    }
}).mount('#app');
</script>
</body>
</html>
