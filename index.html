<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nagoya Trip üçÄ</title>
    
    <!-- PWA Setup -->
    <link rel="icon" type="image/png" href="image2.png">
    <link rel="apple-touch-icon" href="image2.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F5F9F6">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clover: { 50: '#F5F9F6', 100: '#E6F2E8', 200: '#CDE5D2', 300: '#A4D1AD', 400: '#7EB989', 500: '#5E9C6B', 600: '#467A51' },
                        camel: { 50: '#FCFBF9', 100: '#F5F0E6', 200: '#EADFC9', 300: '#C9B8A3', 400: '#B59F85', 500: '#9E866b' },
                        washi: '#FFFEFA', sumi: '#444444', stone: '#999999',
                    },
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'] },
                    boxShadow: { 'soft': '0 8px 30px -8px rgba(164, 209, 173, 0.25)', 'card': '0 4px 20px -4px rgba(0, 0, 0, 0.03)', 'clover': '0 10px 25px -5px rgba(94, 156, 107, 0.2)' },
                    animation: { 'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)', 'bounce-in': 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)' },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        bounceIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F5F9F6; font-family: 'Noto Sans JP', sans-serif; touch-action: manipulation; color: #444444; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .app-container { max-width: 430px; margin: 0 auto; background: #FFFEFA; min-height: 100dvh; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        @media (min-width: 640px) { .app-container { min-height: 90vh; margin-top: 5vh; margin-bottom: 5vh; border-radius: 48px; height: 90vh; border: 8px solid #fff; } }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; } .fade-enter-from, .fade-leave-to { opacity: 0; }
        .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); } .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px) scale(0.95); }
        .timeline-line { background: linear-gradient(to bottom, #CDE5D2 0%, #CDE5D2 50%, transparent 100%); }
    </style>
</head>
<body>

<div id="app">
    <div class="app-container font-sans">
        
        <!-- Loading -->
        <div v-if="isLoading" class="absolute inset-0 z-[300] bg-washi/95 backdrop-blur-sm flex flex-col items-center justify-center transition-opacity duration-500">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-clover-500 mb-4 shadow-clover"></div>
            <p class="text-xs text-clover-600 tracking-[0.3em] font-bold animate-pulse">LOADING</p>
        </div>

        <!-- Identity Modal -->
        <div v-if="!currentUser && !isLoading" class="absolute inset-0 z-[250] bg-sumi/90 backdrop-blur-md flex items-center justify-center p-6 animate-fade-in-up">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 text-center shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-clover-300 to-clover-500"></div>
                <div class="w-16 h-16 rounded-full bg-clover-100 text-clover-500 mx-auto flex items-center justify-center mb-4 text-2xl animate-bounce-in shadow-inner">
                    <i class="fa-solid fa-user-astronaut"></i>
                </div>
                <h3 class="text-xl font-bold text-sumi mb-2">Who are you?</h3>
                <p class="text-xs text-stone mb-6">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑË∫´ÂàÜ‰ª•ÈñãÂßã‰ΩøÁî®</p>
                <div class="grid grid-cols-2 gap-3 max-h-[40vh] overflow-y-auto pr-1">
                    <button v-for="m in members" :key="m" @click="setUser(m)" class="py-3 rounded-xl bg-stone/5 hover:bg-clover-50 hover:text-clover-600 font-bold text-sm transition-all border border-transparent hover:border-clover-200">{{ m }}</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <transition name="toast">
            <div v-if="toast.show" class="fixed top-8 left-1/2 transform -translate-x-1/2 z-[260] bg-white/95 backdrop-blur-md text-sumi px-6 py-3 rounded-full shadow-clover flex items-center space-x-3 min-w-[200px] justify-center border border-clover-100 ring-1 ring-clover-50">
                <i :class="toast.icon" class="text-clover-400 text-lg"></i>
                <span class="text-sm font-medium tracking-wide">{{ toast.message }}</span>
            </div>
        </transition>

        <!-- Image Viewer -->
        <div v-if="showImageModal" class="fixed inset-0 z-[200] bg-sumi/95 backdrop-blur-md flex items-center justify-center p-4 cursor-pointer" @click="showImageModal = false">
            <div class="relative max-w-full max-h-full">
                <img :src="viewImageSrc" class="max-w-full max-h-[85vh] rounded-2xl shadow-2xl animate-bounce-in object-contain bg-white" @click.stop alt="preview image">
                <button class="absolute -top-12 right-0 text-white/80 hover:text-white text-3xl transition" @click="showImageModal = false"><i class="fa-solid fa-circle-xmark"></i></button>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div v-if="confirmModal.show" class="absolute inset-0 bg-sumi/20 backdrop-blur-[2px] z-[210] flex items-center justify-center p-8">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-clover animate-bounce-in text-center border border-clover-50">
                <h3 class="text-lg font-bold text-sumi mb-2 tracking-wide">{{ confirmModal.title }}</h3>
                <p class="text-sm text-stone mb-8 leading-relaxed">{{ confirmModal.message }}</p>
                <div class="flex space-x-3">
                    <button @click="confirmModal.show = false" class="flex-1 py-3 rounded-2xl bg-stone/5 text-stone font-medium text-sm hover:bg-stone/10 transition-colors">ÂèñÊ∂à</button>
                    <button @click="confirmAction" class="flex-1 py-3 rounded-2xl bg-clover-300 text-white font-medium text-sm shadow-lg shadow-clover-200 hover:bg-clover-400 transition-colors">Á¢∫Ë™ç</button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-washi/95 backdrop-blur-sm z-20 sticky top-0 pt-8 pb-2 px-6 shadow-[0_4px_30px_-10px_rgba(0,0,0,0.02)]">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-light tracking-widest text-clover-600 flex items-center">
                        NAGOYA <i class="fa-solid fa-clover text-sm ml-2 text-clover-300 transform -rotate-12"></i>
                    </h1>
                    <p class="text-[10px] text-stone tracking-[0.15em] mt-1 font-medium">
                        2025.12.30 - 2026.01.05
                    </p>
                </div>
                <div class="flex items-center space-x-3">
                     <!-- Lock Toggle (Global Sync) -->
                    <button @click="toggleGlobalLock" :class="isLocked ? 'text-red-400 bg-red-50' : 'text-stone/40 bg-stone/5'" class="w-9 h-9 rounded-full flex items-center justify-center transition-all duration-300 active:scale-95" aria-label="toggle lock">
                        <i :class="isLocked ? 'fa-solid fa-lock text-xs' : 'fa-solid fa-lock-open text-xs'"></i>
                    </button>
                    <!-- User Profile / Logout -->
                    <button v-if="currentUser" @click="confirmLogout" class="w-9 h-9 rounded-full bg-clover-100 text-clover-600 flex items-center justify-center text-xs font-bold shadow-sm border border-clover-200 relative group" aria-label="profile">
                        {{ currentUser.substring(0,1) }}
                        <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-white rounded-full flex items-center justify-center shadow-sm"><i class="fa-solid fa-rotate text-[8px] text-stone"></i></div>
                    </button>
                </div>
            </div>

            <!-- Navigation with Chinese Labels -->
            <div class="flex justify-between items-center px-1">
                <nav class="flex space-x-2 mx-auto w-full justify-between max-w-[340px]">
                    <button v-for="tab in ['traffic', 'split', 'map', 'broadcast', 'info']" :key="tab" @click="currentTab = tab" :class="currentTab === tab ? 'text-clover-500' : 'text-stone/60 hover:text-stone'" class="flex flex-col items-center transition-all duration-500 group relative py-2 px-2 flex-1">
                        <div class="relative">
                            <i :class="{ 'traffic': 'fa-solid fa-train-subway', 'split': 'fa-solid fa-yen-sign', 'map': 'fa-regular fa-map', 'broadcast': 'fa-regular fa-comment-dots', 'info': 'fa-solid fa-basket-shopping' }[tab]" class="text-lg mb-2 transition-transform duration-300" :class="currentTab === tab ? '-translate-y-1' : ''"></i>
                            <span v-if="tab === 'broadcast' && messages.length > 0" class="absolute -top-1 -right-1 w-1.5 h-1.5 bg-camel-400 rounded-full border border-washi animate-pulse"></span>
                        </div>
                        <!-- Translated Labels -->
                        <span class="text-[10px] font-bold tracking-widest opacity-0 group-hover:opacity-100 transition-opacity absolute -bottom-1">{{ tabNameMap[tab] }}</span>
                        <div v-if="currentTab === tab" class="absolute bottom-0 w-1 h-1 bg-clover-400 rounded-full"></div>
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative scroll-smooth px-6 pt-2 pb-24">
            
            <!-- Traffic -->
            <div v-if="currentTab === 'traffic'" class="animate-fade-in-up">
                <div class="sticky top-0 z-10 bg-washi/95 backdrop-blur-md pt-2 pb-6 -mx-6 px-6 mb-2 border-b border-stone/5">
                    <div class="flex space-x-3 overflow-x-auto no-scrollbar items-center py-1">
                        <button v-for="day in days" :key="day" @click="currentDay = day" class="flex flex-col items-center justify-center min-w-[3.5rem] h-14 rounded-2xl transition-all duration-300 group border relative overflow-hidden" :class="currentDay === day ? 'bg-clover-300 text-white border-clover-300 shadow-lg shadow-clover-200 transform scale-105' : 'bg-white text-stone border-transparent hover:bg-white hover:shadow-sm'"><span class="text-[9px] uppercase font-bold tracking-widest mb-0.5 opacity-80">Day</span><span class="text-lg font-medium leading-none">{{ day }}</span></button>
                    </div>
                </div>
                <div class="space-y-0 relative min-h-[300px]">
                    <div v-if="filteredTraffic.length === 0" class="flex flex-col items-center justify-center py-20 text-stone/30"><i class="fa-solid fa-leaf text-4xl mb-4 opacity-30 text-clover-300 animate-pulse"></i><p class="font-light text-xs tracking-[0.2em]">NO SCHEDULE</p></div>
                    <div v-if="filteredTraffic.length > 0" class="absolute top-6 bottom-12 left-[4.5rem] w-[1px] timeline-line z-0"></div>
                    
                    <!-- ‰øÆÊ≠£: isToday ÈÇèËºØÂ∑≤Êõ¥Êñ∞ÔºåÂè™ÊúÉÂú®Ê≠£Á¢∫ÁöÑÊó•ÊúüÈ°ØÁ§∫Á¥ÖÁ∑ö -->
                    <div v-if="isToday" class="absolute left-[4.5rem] w-full z-0 pointer-events-none" :style="{ top: currentTimePercent + '%' }">
                         <div class="w-3 h-3 bg-red-400 rounded-full absolute -left-1.5 -top-1.5 ring-4 ring-red-400/20"></div>
                         <div class="h-[1px] bg-red-400/50 w-full border-t border-dashed border-red-400"></div>
                    </div>

                    <div v-for="item in filteredTraffic" :key="item.id" class="relative z-10 mb-6 last:mb-0 group">
                        <div class="flex items-start">
                            <div class="w-[4.5rem] flex flex-col items-center pt-2 mr-4 flex-shrink-0 bg-washi z-10">
                                <span class="text-sm font-bold text-clover-600 tracking-wide font-mono">{{ item.time }}</span>
                                <span v-if="item.endTime" class="text-[10px] text-stone/60 font-mono mt-1">{{ item.endTime }}</span>
                                <div class="w-8 h-8 rounded-full bg-white border border-clover-100 text-clover-400 flex items-center justify-center text-sm shadow-sm mt-3 mb-2 transition-transform group-hover:scale-110"><i :class="getTransportIcon(item.type)"></i></div>
                            </div>
                            <div class="flex-1 bg-white rounded-[24px] p-5 shadow-card hover:shadow-soft transition-all duration-300 border border-transparent hover:border-clover-100 relative overflow-hidden">
                                <div class="absolute -right-6 -top-6 w-24 h-24 bg-clover-50 rounded-full opacity-60 blur-xl pointer-events-none"></div>
                                <div class="flex justify-between items-start mb-2 relative">
                                    <div>
                                        <div class="text-[9px] text-clover-400 font-bold tracking-widest uppercase mb-1 flex items-center"><span class="w-1.5 h-1.5 bg-clover-300 rounded-full mr-1.5"></span>Destination</div>
                                        <h3 class="text-lg font-medium text-sumi leading-snug">{{ item.destination }}</h3>
                                    </div>
                                    <div class="flex space-x-2 pl-2">
                                        <a v-if="item.url" :href="item.url" target="_blank" rel="noopener noreferrer" class="w-8 h-8 bg-clover-50 text-clover-500 rounded-full flex items-center justify-center hover:bg-clover-500 hover:text-white transition-colors shadow-sm" aria-label="open info"><i class="fa-solid fa-link text-xs"></i></a>
                                        <a v-if="item.ticketUrl" :href="item.ticketUrl" target="_blank" rel="noopener noreferrer" class="w-8 h-8 bg-camel-50 text-camel-400 rounded-full flex items-center justify-center hover:bg-camel-400 hover:text-white transition-colors shadow-sm" aria-label="open ticket"><i class="fa-solid fa-ticket text-xs"></i></a>
                                    </div>
                                </div>
                                <p v-if="item.description" class="text-xs text-stone leading-relaxed whitespace-pre-wrap relative z-10 pl-3 border-l-2 border-clover-100">{{ item.description }}</p>
                                <div v-if="!isLocked" class="flex justify-end space-x-3 mt-4 pt-3 border-t border-clover-50 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="copyTraffic(item)" class="text-xs text-stone hover:text-clover-500 transition-colors flex items-center"><i class="fa-regular fa-copy mr-1"></i> Copy</button>
                                    <button @click="editTraffic(item)" class="text-xs text-stone hover:text-clover-500 transition-colors flex items-center"><i class="fa-solid fa-pen mr-1"></i> Edit</button>
                                    <button @click="askDelete('traffic', item.id)" class="text-xs text-stone hover:text-red-400 transition-colors flex items-center"><i class="fa-solid fa-trash-can mr-1"></i> Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button v-if="!isLocked" @click="openTrafficModal" class="fixed bottom-24 right-6 w-14 h-14 bg-clover-300 text-white rounded-full shadow-lg shadow-clover-200 flex items-center justify-center hover:scale-105 hover:bg-clover-400 transition duration-300 z-20"><i class="fa-solid fa-plus text-xl"></i></button>
            </div>

            <!-- Split -->
            <div v-if="currentTab === 'split'" class="animate-fade-in-up space-y-6 pt-2">
                <div class="flex justify-between items-center px-2">
                    <div class="text-[10px] text-stone tracking-widest font-bold uppercase">ÂåØÁéá (Exchange Rate)</div>
                    <div class="flex items-center space-x-2 bg-white px-4 py-2 rounded-full shadow-sm border border-clover-50">
                        <span class="text-xs text-stone">JPY 1 = TWD</span>
                        <span class="w-14 text-right font-bold text-clover-600 bg-transparent border-b border-dotted border-clover-300 text-sm pb-0.5">{{ exchangeRate }}</span>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-clover-300 to-clover-400 rounded-[32px] p-8 text-white shadow-lg shadow-clover-200 relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-20 rounded-full blur-3xl"></div>
                    <h2 class="text-[10px] tracking-[0.2em] opacity-80 mb-2 uppercase flex items-center"><i class="fa-solid fa-clover mr-2 opacity-50"></i>Á∏ΩË®àËä±Ë≤ª</h2>
                    <div class="flex items-baseline space-x-2"><span class="text-lg opacity-80 font-light">NT$</span><span class="text-5xl font-light tracking-tight">{{ Math.round(totalExpense).toLocaleString() }}</span></div>
                    <div class="mt-8 bg-white/20 backdrop-blur-sm rounded-2xl p-4 border border-white/20">
                        <p v-if="debts.length === 0" class="text-center text-xs opacity-90 py-2 tracking-wider">All settled ‚ú®</p>
                        <div v-else class="space-y-3">
                            <div v-for="debt in debts" :key="debt.text" class="flex justify-between items-center text-xs border-b border-white/10 pb-2 last:border-0 last:pb-0">
                                <div class="flex items-center space-x-3"><span class="font-bold bg-white/30 px-2 py-1 rounded-lg">{{ debt.from }}</span><i class="fa-solid fa-arrow-right-long opacity-70 text-[10px]"></i><span class="font-bold bg-white/30 px-2 py-1 rounded-lg">{{ debt.to }}</span></div>
                                <span class="font-medium tracking-wide">NT$ {{ Math.round(debt.amount).toLocaleString() }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="!isLocked" class="bg-white rounded-[32px] p-6 shadow-card border border-transparent relative overflow-hidden">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="font-medium text-sumi tracking-wide">Êñ∞Â¢ûÊîØÂá∫</h3>
                        <div class="flex bg-clover-50 rounded-xl p-1"><button @click="currencyMode = 'JPY'" :class="currencyMode === 'JPY' ? 'bg-white text-clover-600 shadow-sm' : 'text-stone'" class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all">JPY</button><button @click="currencyMode = 'TWD'" :class="currencyMode === 'TWD' ? 'bg-white text-clover-600 shadow-sm' : 'text-stone'" class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all">TWD</button></div>
                    </div>
                    <div class="space-y-4">
                        <input v-model="newExpense.description" placeholder="È†ÖÁõÆÂêçÁ®±..." class="w-full bg-clover-50/50 border-none rounded-2xl p-4 text-sm text-sumi focus:ring-2 focus:ring-clover-100 outline-none placeholder-stone/40" enterkeyhint="next">
                        <div class="flex space-x-3 relative">
                            <div class="flex-1 relative">
                                <span class="absolute left-4 top-4 text-stone/50 text-sm font-bold">{{ currencyMode === 'JPY' ? '¬•' : '$' }}</span>
                                <input v-model.number="newExpense.inputAmount" type="number" placeholder="0" class="w-full pl-8 bg-clover-50/50 border-none rounded-2xl p-4 text-sm text-sumi focus:ring-2 focus:ring-clover-100 outline-none font-mono" enterkeyhint="done">
                                <div v-if="newExpense.inputAmount" class="absolute right-4 top-4.5 text-[10px] text-stone/50 font-mono pointer-events-none">{{ Number(newExpense.inputAmount).toLocaleString() }}</div>
                            </div>
                            <div class="flex items-center justify-center px-4 bg-clover-50/50 rounded-2xl min-w-[90px]"><div class="text-right"><div class="text-[9px] text-stone uppercase tracking-wide">NT$</div><div class="text-xs text-sumi font-bold">{{ calculatedTWD.toLocaleString() }}</div></div></div>
                        </div>
                        <div class="pt-2">
                            <label class="text-[10px] text-stone tracking-widest uppercase block mb-3 ml-1">‰ªòÊ¨æ‰∫∫</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button v-for="member in members" :key="member" @click="newExpense.payer = member" :class="newExpense.payer === member ? 'bg-clover-300 text-white shadow-md' : 'bg-clover-50/50 text-stone hover:bg-clover-50'" class="py-2.5 rounded-xl text-xs transition-all duration-300 truncate font-medium">{{ member }}</button>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-dashed border-stone/10 flex items-center space-x-3">
                            <div v-if="newExpense.image" class="relative w-16 h-16 rounded-xl overflow-hidden group shadow-sm"><img :src="newExpense.image" class="w-full h-full object-cover"><button @click="newExpense.image = ''" class="absolute inset-0 bg-black/40 text-white flex items-center justify-center"><i class="fa-solid fa-times"></i></button></div>
                            <label class="flex-1 h-12 rounded-xl border-2 border-dashed border-clover-200 hover:border-clover-400 bg-clover-50/50 flex items-center justify-center text-clover-400 cursor-pointer text-xs font-bold gap-2 active:bg-clover-100 transition"><i class="fa-solid fa-camera"></i> RECEIPT<input type="file" accept="image/*" class="hidden" @change="handleExpenseImage"></label>
                        </div>
                        <button @click="addExpense" class="w-full mt-2 bg-stone/5 text-sumi py-4 rounded-2xl text-sm font-medium hover:bg-clover-300 hover:text-white transition duration-300 flex items-center justify-center"><i class="fa-solid fa-plus mr-2"></i> Êñ∞Â¢û‰∏ÄÁ≠Ü</button>
                    </div>
                </div>

                <div class="bg-white rounded-[32px] p-6 shadow-card">
                    <h3 class="text-xs font-bold text-stone tracking-widest uppercase mb-4 pl-2 border-l-2 border-camel-300">ÂÄã‰∫∫ÊîØÂá∫ÊòéÁ¥∞</h3>
                    <div class="grid grid-cols-4 gap-2 mb-6">
                        <button v-for="m in members" :key="m" @click="selectedPayerForDetail = m" :class="selectedPayerForDetail === m ? 'bg-camel-300 text-white shadow-md' : 'bg-clover-50/50 text-stone hover:bg-camel-50'" class="px-1 py-2.5 rounded-xl text-xs transition-all font-medium truncate">{{ m }}</button>
                    </div>
                    <div v-if="selectedPayerForDetail" class="bg-clover-50/30 rounded-2xl p-4">
                        <div v-if="payerExpenses.length === 0" class="text-center text-stone/40 text-xs py-8">No records found</div>
                        <div class="space-y-3 max-h-60 overflow-y-auto pr-2 scrollbar-thin">
                            <div v-for="(exp, index) in payerExpenses" :key="index" class="flex justify-between items-center text-sm group">
                                <div class="flex-1 min-w-0 mr-4"><div class="text-sumi truncate text-xs font-medium">{{ exp.description }}</div><div class="text-[9px] text-stone mt-0.5">{{ exp.date }}</div></div>
                                <div class="flex items-center"><span class="font-mono text-clover-600 text-xs mr-2">NT$ {{ Math.round(exp.amount).toLocaleString() }}</span><button v-if="exp.image" @click.stop="openImageModal(exp.image)" class="text-stone/40 hover:text-clover-500"><i class="fa-regular fa-image"></i></button></div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-dashed border-stone/20 flex justify-between items-center"><span class="text-[10px] text-stone font-bold tracking-widest uppercase">Total</span><span class="text-lg font-medium text-sumi font-mono">NT$ {{ Math.round(payerTotal).toLocaleString() }}</span></div>
                    </div>
                    <div class="mt-4 text-center"><button @click="exportToCSV" class="text-xs text-stone/50 hover:text-clover-600 underline tracking-wider"><i class="fa-solid fa-file-csv mr-1.5"></i>ÂåØÂá∫ CSV</button></div>
                </div>
                
                 <div class="space-y-3">
                    <h3 class="text-[10px] text-stone tracking-widest uppercase pl-4 mb-1">ËøëÊúüÊîØÂá∫</h3>
                    <div v-for="(exp, index) in expenses.slice().reverse().slice(0, 5)" :key="index" class="bg-white px-5 py-4 rounded-2xl flex justify-between items-center group border border-transparent hover:border-clover-50 shadow-sm">
                        <div class="flex items-center space-x-4 overflow-hidden"><div class="w-9 h-9 rounded-full bg-clover-50 text-clover-500 flex items-center justify-center text-xs font-bold">{{ exp.payer.substring(0,1) }}</div><div class="min-w-0"><p class="text-sumi text-sm truncate font-medium">{{ exp.description }}</p><p class="text-[10px] text-stone mt-0.5">{{ exp.date }}</p></div></div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center space-x-2"><div class="text-sm font-bold text-sumi font-mono">NT$ {{ Math.round(exp.amount).toLocaleString() }}</div><button v-if="exp.image" @click.stop="openImageModal(exp.image)" class="text-stone/30 hover:text-clover-500 text-xs"><i class="fa-regular fa-image"></i></button></div>
                            <button v-if="!isLocked" @click="askDelete('expense', expenses.length - 1 - index)" class="text-xs text-stone hover:text-red-400 mt-1"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Public Wallet -->
                <div class="mt-8 bg-white rounded-[32px] p-6 shadow-card border border-clover-100/50">
                    <div class="flex items-center mb-6"><div class="w-10 h-10 rounded-full bg-clover-100 text-clover-500 flex items-center justify-center mr-3 shadow-inner"><i class="fa-solid fa-wallet text-lg"></i></div><div><h3 class="text-base font-bold text-sumi tracking-wide">ÂÖ¨Ë≤ªÈå¢ÂåÖ</h3><p class="text-[10px] text-stone tracking-wider uppercase">Public Wallet</p></div></div>
                    <div class="bg-gradient-to-br from-stone-50 to-clover-50/30 rounded-2xl p-5 mb-6 border border-stone/5">
                        <div class="flex justify-between items-end mb-1"><span class="text-[10px] text-stone font-bold tracking-widest uppercase">È§òÈ°ç (Balance)</span><div class="text-right"><span class="text-xs text-stone mr-1">NT$</span><span class="text-2xl font-light text-clover-600 font-mono">{{ Math.round(remainingPublicFund).toLocaleString() }}</span></div></div>
                        <div class="w-full h-1.5 bg-white rounded-full overflow-hidden shadow-inner mb-4"><div class="h-full bg-clover-400 rounded-full transition-all duration-1000 ease-out relative" :style="{ width: publicFundPercentage + '%' }"></div></div>
                        
                        <!-- Set Total (Modified with Currency Toggle) -->
                        <div v-if="!isLocked" class="pt-4 border-t border-dashed border-stone/10">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[9px] text-stone tracking-widest uppercase"><i class="fa-solid fa-gear mr-1"></i>Ë®≠ÂÆöÁ∏ΩÈ°ç</label>
                                <div class="flex bg-stone-100 rounded-lg p-0.5"><button @click="publicFundCurrencyMode = 'JPY'" :class="publicFundCurrencyMode === 'JPY' ? 'bg-white text-sumi shadow-sm' : 'text-stone/50'" class="px-2 py-0.5 rounded-md text-[9px] font-bold transition-all">JPY</button><button @click="publicFundCurrencyMode = 'TWD'" :class="publicFundCurrencyMode === 'TWD' ? 'bg-white text-sumi shadow-sm' : 'text-stone/50'" class="px-2 py-0.5 rounded-md text-[9px] font-bold transition-all">TWD</button></div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-[10px] font-bold text-stone/50">{{ publicFundCurrencyMode === 'JPY' ? '¬•' : '$' }}</span>
                                <input v-model.number="publicFundInput" type="number" placeholder="Amount..." class="flex-1 min-w-0 bg-white border-none rounded-xl px-3 py-2 text-sm text-sumi outline-none font-mono shadow-sm">
                                <button @click="updatePublicFund" class="bg-sumi text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-clover-500"><i class="fa-solid fa-check text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Public Expense (Modified with Currency Toggle & Image Upload) -->
                    <div v-if="!isLocked" class="mb-6">
                        <div class="flex justify-between items-center mb-3 border-l-2 border-camel-300 pl-2">
                            <h4 class="text-[10px] text-stone tracking-widest uppercase font-bold">Êñ∞Â¢ûÂÖ¨Ë≤ªÊîØÂá∫</h4>
                            <div class="flex bg-stone-100 rounded-lg p-0.5"><button @click="newPublicExpense.currency = 'JPY'" :class="newPublicExpense.currency === 'JPY' ? 'bg-white text-sumi shadow-sm' : 'text-stone/50'" class="px-2 py-0.5 rounded-md text-[9px] font-bold transition-all">JPY</button><button @click="newPublicExpense.currency = 'TWD'" :class="newPublicExpense.currency === 'TWD' ? 'bg-white text-sumi shadow-sm' : 'text-stone/50'" class="px-2 py-0.5 rounded-md text-[9px] font-bold transition-all">TWD</button></div>
                        </div>
                        <div class="space-y-3">
                            <input v-model="newPublicExpense.name" placeholder="È†ÖÁõÆ..." class="w-full bg-stone/5 border-none rounded-2xl px-4 py-3 text-sm">
                            <div class="flex space-x-2 items-center">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-3 text-stone/50 text-[10px] font-bold">{{ newPublicExpense.currency === 'JPY' ? '¬•' : '$' }}</span>
                                    <input v-model.number="newPublicExpense.inputAmount" type="number" placeholder="ÈáëÈ°ç..." class="w-full bg-stone/5 border-none rounded-2xl pl-7 pr-4 py-3 text-sm font-mono">
                                </div>
                                <button @click="addPublicExpense" class="bg-camel-400 text-white w-12 h-[44px] rounded-2xl flex items-center justify-center shadow-md"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <!-- Added Image Upload for Public Wallet -->
                            <div class="flex items-center space-x-2 pt-1">
                                <div v-if="newPublicExpense.image" class="relative w-10 h-10 rounded-lg overflow-hidden group shadow-sm"><img :src="newPublicExpense.image" class="w-full h-full object-cover"><button @click="newPublicExpense.image = ''" class="absolute inset-0 bg-black/40 text-white flex items-center justify-center"><i class="fa-solid fa-times text-xs"></i></button></div>
                                <label class="flex-1 h-10 rounded-xl border border-dashed border-stone/30 hover:border-camel-400 bg-stone/5 flex items-center justify-center text-stone/50 hover:text-camel-400 cursor-pointer text-[10px] font-bold gap-2 transition"><i class="fa-solid fa-camera"></i> ADD RECEIPT<input type="file" accept="image/*" class="hidden" @change="handlePublicImage"></label>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-[10px] text-stone tracking-widest uppercase font-bold mb-3 pl-2 border-l-2 border-stone/30">ÊòéÁ¥∞ ({{ publicExpenses.length }})</h4>
                        <div v-for="item in publicExpenses.slice().reverse()" :key="item.id" class="flex justify-between items-center p-3.5 bg-stone/5 rounded-2xl mb-2"><div class="flex-1 min-w-0 mr-3"><div class="text-sm font-medium text-sumi truncate">{{ item.name }}</div><div class="text-[9px] text-stone mt-1">{{ item.date }}</div></div><div class="flex items-center space-x-3"><span class="font-mono text-sm font-bold text-sumi">NT$ {{ Math.round(item.amount).toLocaleString() }}</span>
                            <!-- View Image Button -->
                            <button v-if="item.image" @click.stop="openImageModal(item.image)" class="text-stone/40 hover:text-clover-500"><i class="fa-regular fa-image"></i></button>
                            <button v-if="!isLocked" @click="askDelete('publicExpense', item.id)" class="text-stone/40 hover:text-red-400"><i class="fa-solid fa-trash-can text-[10px]"></i></button></div></div>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div v-if="currentTab === 'map'" class="animate-fade-in-up space-y-6 pt-2">
                <div>
                    <h3 class="text-[10px] text-stone tracking-widest uppercase font-bold mb-3 px-2">Â∏∏Áî®‰ΩçÁΩÆ</h3>
                    <div class="space-y-3">
                         <div v-if="locations.length === 0" class="text-center py-8 text-stone/40 text-xs">Â∞öÁÑ°Â∏∏Áî®‰ΩçÁΩÆ</div>
                        <div v-for="loc in locations" :key="loc.id" class="bg-white rounded-[24px] p-5 shadow-card group relative hover:shadow-soft transition-all">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1"><i class="fa-solid fa-location-dot text-clover-400"></i><h4 class="text-lg font-medium text-sumi">{{ loc.name }}</h4></div>
                                    <p class="text-xs text-stone pl-6 mb-3">{{ loc.description }}</p>
                                    <a v-if="loc.url" :href="loc.url" target="_blank" class="inline-flex items-center space-x-1 text-[10px] font-bold text-camel-400 bg-camel-50 px-3 py-1.5 rounded-full ml-6"><i class="fa-solid fa-map-location-dot"></i><span>Google Maps</span></a>
                                </div>
                                <div v-if="!isLocked" class="flex flex-col space-y-2"><button @click="editLocation(loc)" class="w-8 h-8 rounded-full bg-clover-50 text-stone hover:text-clover-500 flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button><button @click="askDelete('location', loc.id)" class="w-8 h-8 rounded-full bg-clover-50 text-stone hover:text-red-400 flex items-center justify-center"><i class="fa-solid fa-trash-can text-xs"></i></button></div>
                            </div>
                        </div>
                    </div>
                    <div v-if="!isLocked" class="flex justify-center mt-6"><button @click="openLocationModal" class="w-14 h-14 rounded-full bg-white border-2 border-dashed border-clover-200 text-clover-400 flex items-center justify-center hover:bg-clover-50 shadow-sm"><i class="fa-solid fa-plus text-xl"></i></button></div>
                </div>
                <div class="bg-white rounded-[32px] p-6 shadow-card">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-[10px] text-stone tracking-widest uppercase font-bold border-l-2 border-clover-300 pl-2">Êú™‰æÜ‰∏ÄÂë®Â§©Ê∞£</h3><select v-model="weatherCity" @change="fetchWeather" class="text-xs font-bold text-clover-600 bg-clover-50 border-none rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-clover-200 outline-none"><option value="Nagoya">ÂêçÂè§Â±ã</option><option value="Takayama">È´òÂ±±</option><option value="Shirakawa">ÂêàÊéåÊùë</option><option value="Kanazawa">ÈáëÊæ§</option></select></div>
                    <div v-if="!weatherData.daily" class="text-center py-8 text-stone/40"><i class="fa-solid fa-spinner fa-spin mb-2"></i></div>
                    <div v-else class="flex overflow-x-auto no-scrollbar space-x-4 pb-2"><div v-for="(day, index) in 7" :key="index" class="flex-shrink-0 flex flex-col items-center min-w-[4rem] bg-clover-50/50 rounded-2xl py-3 px-1"><span class="text-[10px] text-stone font-bold uppercase mb-1">{{ getWeatherDay(index) }}</span><i :class="getWeatherIcon(weatherData.daily.weathercode[index])" class="text-xl text-clover-400 mb-2"></i><div class="flex flex-col items-center text-[10px] font-mono font-medium text-sumi"><span>{{ Math.round(weatherData.daily.temperature_2m_max[index]) }}¬∞</span><span class="text-stone">{{ Math.round(weatherData.daily.temperature_2m_min[index]) }}¬∞</span></div></div></div>
                </div>
            </div>

            <!-- Broadcast -->
            <div v-if="currentTab === 'broadcast'" class="h-full flex flex-col pb-4 animate-fade-in-up">
                <div class="flex-1 overflow-y-auto space-y-6 pb-4 pt-2 px-2" ref="msgContainer">
                    <div v-if="messages.length === 0" class="text-center py-32 opacity-30"><i class="fa-regular fa-comments text-4xl mb-4 text-stone"></i><p class="text-xs text-stone tracking-widest">START CONVERSATION</p></div>
                    <div v-for="msg in messages" :key="msg.id" class="flex flex-col items-start group">
                        <div class="flex items-end space-x-3 max-w-[90%]">
                            <div class="w-8 h-8 rounded-2xl bg-white border border-clover-100 text-clover-500 flex items-center justify-center text-[10px] font-bold flex-shrink-0 shadow-sm mb-1">{{ msg.user.substring(0,1) }}</div>
                            <div>
                                <span class="text-[9px] text-stone ml-2 mb-1 block tracking-wide">{{ msg.user }}</span>
                                <div class="bg-white px-5 py-3 rounded-2xl rounded-tl-none shadow-card text-sm text-sumi relative leading-relaxed">{{ msg.text }}<div class="text-[9px] text-stone/50 text-right mt-1 font-mono">{{ msg.time }}</div><button v-if="!isLocked" @click="askDelete('message', msg.id)" class="absolute -top-2 -right-2 bg-clover-50 text-stone hover:text-red-400 rounded-full w-5 h-5 hidden group-hover:flex items-center justify-center text-[10px] shadow-sm border border-stone/10"><i class="fa-solid fa-times"></i></button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 pb-8 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] rounded-t-[32px] border-t border-clover-50">
                    <div class="flex flex-col space-y-3">
                        <input v-model="msgText" placeholder="Write a message..." class="w-full bg-clover-50/50 rounded-2xl p-4 border border-transparent focus:border-clover-100 focus:bg-white transition-all duration-300 outline-none text-sm text-sumi" @keyup.enter="sendMessage" enterkeyhint="send">
                        <button @click="sendMessage" class="w-full py-3 bg-clover-300 text-white rounded-2xl hover:bg-clover-400 shadow-sm flex items-center justify-center font-bold tracking-widest text-[10px]">SEND <i class="fa-solid fa-paper-plane ml-2"></i></button>
                    </div>
                </div>
            </div>

            <!-- Info (Shopping) -->
            <div v-if="currentTab === 'info'" class="animate-fade-in-up pt-2">
                <div class="px-2 mb-4">
                    <h2 class="text-[10px] tracking-widest font-bold uppercase text-stone mb-4 pl-4 border-l-2 border-clover-300 flex justify-between items-center">
                        <span>Ë≥ºË≤∑Ê∏ÖÂñÆ (Shopping)</span>
                        <span v-if="currentShoppingMember" class="text-clover-500 font-bold bg-clover-50 px-2 py-0.5 rounded-md">{{ currentShoppingMember }}</span>
                    </h2>
                    <div class="mb-6 px-1 grid grid-cols-4 gap-2"><button v-for="member in members" :key="member" @click="toggleShoppingMember(member)" :class="currentShoppingMember === member ? 'bg-clover-300 text-white shadow-md' : 'bg-white text-stone border border-stone/10'" class="py-2.5 rounded-xl text-xs font-medium transition-all truncate">{{ member }}</button></div>
                    <div v-if="filteredShoppingList.length === 0" class="flex flex-col items-center justify-center py-20 text-stone/30"><i class="fa-solid fa-basket-shopping text-4xl mb-4 opacity-30 text-clover-300"></i><p class="font-light text-xs tracking-[0.2em]">EMPTY LIST</p></div>

                    <div class="space-y-4 px-1 mb-8">
                        <div v-for="item in sortedShoppingList" :key="item.id" class="bg-white rounded-[24px] p-5 shadow-card group relative flex flex-col transition-all duration-300 border border-transparent" :class="item.isBought ? 'opacity-60 grayscale-[0.8] order-last bg-stone-50' : 'order-first'">
                            
                            <div v-if="item.owner" class="absolute top-4 left-4 z-10"><span class="bg-white/90 backdrop-blur-md text-clover-600 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm border border-stone/5">{{ item.owner }}</span></div>
                            
                            <div class="absolute top-4 right-4 z-10 flex space-x-2">
                                <a v-if="item.link" :href="item.link" target="_blank" class="w-9 h-9 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center text-clover-500 shadow-sm border border-stone/5" @click.stop><i class="fa-solid fa-link text-sm"></i></a>
                                <!-- Check Button -->
                                <button @click="toggleBought(item)" class="w-9 h-9 backdrop-blur-md rounded-full flex items-center justify-center shadow-sm transition-colors border border-stone/5" :class="item.isBought ? 'bg-clover-500 text-white' : 'bg-white/90 text-stone/30 hover:text-clover-500'"><i class="fa-solid fa-check text-sm"></i></button>
                            </div>

                            <div class="relative w-full aspect-[4/3] mb-4 rounded-2xl overflow-hidden bg-clover-50/50 border border-stone/5">
                                <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full flex items-center justify-center text-clover-200"><i class="fa-solid fa-image text-4xl"></i></div>
                                <!-- Bought Overlay -->
                                <div v-if="item.isBought" class="absolute inset-0 bg-stone-900/10 flex items-center justify-center backdrop-blur-[1px]"><span class="bg-white text-clover-600 px-4 py-1 rounded-full font-bold text-xs tracking-widest shadow-md">BOUGHT</span></div>
                            </div>
                            
                            <h3 class="font-bold text-sumi text-lg mb-2 px-1" :class="item.isBought ? 'line-through decoration-clover-500 text-stone' : ''">{{ item.name }}</h3>
                            <p class="text-sm text-stone px-1 leading-7 whitespace-pre-wrap">{{ item.description }}</p>
                            
                            <div v-if="!isLocked" class="flex justify-end space-x-3 mt-4 pt-3 border-t border-stone/5">
                                <button @click="editShopping(item)" class="text-xs text-stone hover:text-clover-500 flex items-center px-2 py-1"><i class="fa-solid fa-pen mr-1.5"></i> Edit</button>
                                <button @click="askDelete('shopping', item.id)" class="text-xs text-stone hover:text-red-400 flex items-center px-2 py-1"><i class="fa-solid fa-trash-can mr-1.5"></i> Delete</button>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="!isLocked" class="flex justify-center pb-8 pt-4 border-t border-dashed border-stone/10"><button @click="openShoppingModal" class="flex items-center space-x-2 bg-clover-300 text-white py-3 px-8 rounded-full shadow-lg shadow-clover-200 hover:bg-clover-400 transition-all group"><i class="fa-solid fa-plus text-sm"></i><span class="text-xs font-bold tracking-widest">ADD ITEM</span></button></div>
                </div>
            </div>

        </main>

        <!-- Modals -->
        <div v-if="showTrafficModal" class="absolute inset-0 bg-sumi/20 backdrop-blur-[2px] z-50 flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:w-[400px] sm:rounded-[32px] rounded-t-[32px] p-8 shadow-2xl animate-fade-in-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8"><h3 class="text-lg font-bold text-sumi tracking-wide"><i class="fa-solid fa-pen-to-square text-clover-300 mr-2"></i> {{ isEditingTraffic ? 'Edit' : 'Add' }} Transport</h3><button @click="showTrafficModal = false" class="w-8 h-8 rounded-full bg-clover-50 text-stone hover:bg-stone/10 flex items-center justify-center"><i class="fa-solid fa-times"></i></button></div>
                <div class="space-y-5">
                    <div class="grid grid-cols-5 gap-2"><button v-for="t in ['plane', 'train', 'bus', 'taxi', 'walk']" :key="t" @click="trafficModalData.type = t" :class="trafficModalData.type === t ? 'bg-clover-300 text-white shadow-md' : 'bg-clover-50 text-stone'" class="p-3 rounded-2xl flex justify-center items-center aspect-square"><i :class="getTransportIcon(t)" class="text-lg"></i></button></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">START</label><input v-model="trafficModalData.time" type="time" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm font-mono"></div><div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">END</label><input v-model="trafficModalData.endTime" type="time" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm font-mono"></div></div>
                    <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">DESTINATION</label><input v-model="trafficModalData.destination" type="text" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"></div>
                    <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2">NOTE</label><textarea v-model="trafficModalData.description" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm h-24 resize-none"></textarea></div>
                    <div class="grid grid-cols-1 gap-3"><input v-model="trafficModalData.url" type="text" placeholder="Info Link" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"><input v-model="trafficModalData.ticketUrl" type="text" placeholder="Ticket Link" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"></div>
                    <button @click="saveTraffic" class="w-full py-4 rounded-2xl bg-clover-300 text-white font-medium shadow-lg hover:bg-clover-400 mt-2">Save</button>
                </div>
            </div>
        </div>
        
        <div v-if="showLocationModal" class="absolute inset-0 bg-sumi/20 backdrop-blur-[2px] z-50 flex items-end sm:items-center justify-center p-6">
             <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl animate-fade-in-up">
                 <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-sumi tracking-wide">Location</h3><button @click="showLocationModal = false" class="w-8 h-8 rounded-full bg-clover-50 text-stone hover:bg-stone/10 flex items-center justify-center"><i class="fa-solid fa-times"></i></button></div>
                <div class="space-y-4"><input v-model="locationModalData.name" type="text" placeholder="Name" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"><input v-model="locationModalData.description" type="text" placeholder="Description" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"><input v-model="locationModalData.url" type="text" placeholder="Google Maps URL" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"><button @click="saveLocation" class="w-full py-3 rounded-2xl bg-clover-300 text-white font-medium shadow-lg mt-2">Save</button></div>
            </div>
        </div>

        <div v-if="showShoppingModal" class="absolute inset-0 bg-sumi/20 backdrop-blur-[2px] z-50 flex items-end sm:items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl animate-fade-in-up">
                 <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-sumi tracking-wide">Item</h3><button @click="showShoppingModal = false" class="w-8 h-8 rounded-full bg-clover-50 text-stone hover:bg-stone/10 flex items-center justify-center"><i class="fa-solid fa-times"></i></button></div>
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-1 -mr-1">
                    <div class="relative w-full aspect-video bg-clover-50 rounded-2xl overflow-hidden border-2 border-dashed border-clover-200 hover:border-clover-300 transition group cursor-pointer" @click="$refs.fileInput.click()"><input type="file" ref="fileInput" accept="image/*" class="hidden" @change="handleImageUpload"><img v-if="shoppingModalData.image" :src="shoppingModalData.image" class="w-full h-full object-cover"><div v-else class="absolute inset-0 flex flex-col items-center justify-center text-clover-300"><i class="fa-solid fa-camera text-2xl mb-2"></i><span class="text-[10px] font-bold tracking-widest">ADD PHOTO</span></div></div>
                    <input v-model="shoppingModalData.name" type="text" placeholder="Name" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"><input v-model="shoppingModalData.link" type="text" placeholder="Link" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm"><textarea v-model="shoppingModalData.description" placeholder="Description" class="w-full bg-clover-50 border-none rounded-2xl p-4 text-sm h-24 resize-none"></textarea>
                    <div><label class="text-[10px] font-bold text-stone tracking-widest block mb-2 pl-1">OWNER</label><div class="grid grid-cols-4 gap-2"><button v-for="member in members" :key="member" @click="shoppingModalData.owner = member" :class="shoppingModalData.owner === member ? 'bg-camel-300 text-white shadow-md' : 'bg-clover-50 text-stone hover:bg-clover-100'" class="py-2 rounded-xl text-[10px] font-medium transition-all truncate">{{ member }}</button></div></div>
                    <button @click="saveShoppingItem" class="w-full py-3 rounded-2xl bg-clover-300 text-white font-medium shadow-lg mt-2">Save</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref as dbRef, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getStorage, ref as storageRef, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyDRtLqLIPtLB7WmGqwbS4YjRHpDRF8Rv0g",
  authDomain: "nagoya-snow-tour.firebaseapp.com",
  databaseURL: "https://nagoya-snow-tour-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nagoya-snow-tour",
  storageBucket: "nagoya-snow-tour.firebasestorage.app",
  messagingSenderId: "189759409360",
  appId: "1:189759409360:web:26ef01e7ae294a1222a2d5",
  measurementId: "G-PS3ZL41FYT"
};

try {
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    window.firebaseDb = db; 
    window.firebaseStorage = storage;
} catch (error) {
    console.error("Firebase Init Error:", error);
    // Allow app to continue offline even if init fails (will use local storage)
    window.firebaseDb = null;
    window.firebaseStorage = null;
}

const db = window.firebaseDb;
const storage = window.firebaseStorage;
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        // ‰øÆÊ≠£: ÂºïÂÖ• isRemoteUpdate ÊóóÊ®ô‰ª•Èò≤Ê≠¢ÁÑ°ÈôêËø¥Âúà
        const isRemoteUpdate = ref(false);
        const isLoading = ref(true);
        const currentUser = ref(null);
        const isLocked = ref(false); // Global Lock Status

        const currentTab = ref('traffic');
        // Chinese Translation Map for Tabs
        const tabNameMap = { 'traffic': '‰∫§ÈÄö', 'split': 'ÂàÜÂ∏≥', 'map': 'Âú∞Âúñ', 'broadcast': 'ÁïôË®Ä', 'info': 'Ë≥áË®ä' };
        
        const currentDay = ref(1);
        const days = ref([1, 2, 3, 4, 5, 6, 7]); 
        const showTrafficModal = ref(false);
        const isEditingTraffic = ref(false);
        const editingTrafficId = ref(null);
        const toast = ref({ show: false, message: '', icon: '' });
        const confirmModal = ref({ show: false, title: '', message: '', targetId: null, targetType: '' });
        const fixedMembers = ['ÊòéÂ≠∏', 'ÂòâÊó∫', 'ÈÉ°Âì≤', 'ÊüèÁø∞', 'ËÅøÁéÑ', 'Â∏∏Èßê', 'Âéö‰ªÅ', 'Â©âÁëú'];
        const showImageModal = ref(false);
        const viewImageSrc = ref('');
        const cityCoords = { 'Nagoya': { lat: 35.1815, lon: 136.9066 }, 'Takayama': { lat: 36.1407, lon: 137.2595 }, 'Shirakawa': { lat: 36.2566, lon: 136.9043 }, 'Kanazawa': { lat: 36.5613, lon: 136.6562 } };
        
        const trafficList = ref([]);
        const members = ref([...fixedMembers]);
        const expenses = ref([]);
        const messages = ref([]);
        const locations = ref([]);
        const exchangeRate = ref(0.215); 
        const shoppingList = ref([]);
        const showShoppingModal = ref(false);
        const isEditingShopping = ref(false);
        const editingShoppingId = ref(null);
        const shoppingModalData = ref({ name: '', description: '', image: '', owner: '', link: '', isBought: false });
        const currentShoppingMember = ref(null);
        const publicExpenses = ref([]);
        const publicFundTotal = ref(0);
        const publicFundInput = ref('');
        const publicFundCurrencyMode = ref('JPY'); // New toggle for fund setting
        const newPublicExpense = ref({ name: '', inputAmount: '', currency: 'JPY', image: '' }); // Default currency
        const currencyMode = ref('JPY'); 
        const weatherCity = ref('Nagoya');
        const weatherData = ref({});
        const newExpense = ref({ description: '', inputAmount: '', payer: '', image: '' });
        const trafficModalData = ref({ time: '09:00', endTime: '', type: 'train', destination: '', description: '', url: '', ticketUrl: '' }); 
        const msgText = ref('');
        const msgUser = ref(fixedMembers[0]);
        const msgContainer = ref(null);
        const selectedPayerForDetail = ref(fixedMembers[0]);
        const locationModalData = ref({ name: '', description: '', url: '' });
        const showLocationModal = ref(false);
        const isEditingLocation = ref(false);
        const editingLocationId = ref(null);

        // ‰øÆÊ≠£: ÂÆöÁæ©ÊóÖÈÅäÈñãÂßãÊó•Êúü
        const TRIP_START_DATE = new Date('2025-12-30T00:00:00+09:00');

        // Helper: Get Japan Date Object (Fix for Timezone)
        // ‰ΩøÁî®ÂéüÁîü JS Âº∑Âà∂ËΩâÊèõÊôÇÂçÄÔºåÁÑ°ÈúÄÂºïÂÖ•È°çÂ§ñ Library
        const getJapanDateObj = () => {
            const date = new Date();
            // Create a date string in JST (Asia/Tokyo)
            const jstString = date.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' });
            return new Date(jstString);
        };
        
        // Helper: Formatters for Japan Time
        const getJapanDateStr = () => getJapanDateObj().toLocaleDateString('zh-TW');
        const getJapanTimeStr = () => getJapanDateObj().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });

        const showToast = (msg, type = 'success') => { toast.value = { show: true, message: msg, icon: type === 'error' ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-clover' }; setTimeout(() => { toast.value.show = false; }, 3000); };
        const openImageModal = (src) => { viewImageSrc.value = src; showImageModal.value = true; };
        
        const fetchRealTimeExchangeRate = async () => {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if(data && data.rates && data.rates.TWD) exchangeRate.value = parseFloat(data.rates.TWD.toFixed(3));
            } catch(e) {}
        };

        const processImage = (file, callback) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; 
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // Helper: Upload Image to Firebase Storage
        const uploadImageToStorage = async (base64String, folderName) => {
            if (!base64String || !storage) return '';
            // If it's already a URL (editing existing item), return it
            if (base64String.startsWith('http')) return base64String;

            try {
                // Create unique filename: folder/timestamp.jpg
                const fileName = `${folderName}/${Date.now()}.jpg`;
                const imageRef = storageRef(storage, fileName);
                
                // Upload Base64 string (processImage outputs data_url)
                await uploadString(imageRef, base64String, 'data_url');
                
                // Get Download URL
                const downloadURL = await getDownloadURL(imageRef);
                return downloadURL;
            } catch (error) {
                console.error("Upload failed:", error);
                showToast("ÂúñÁâá‰∏äÂÇ≥Â§±Êïó", "error");
                return '';
            }
        };

        const setUser = (name) => {
            currentUser.value = name;
            localStorage.setItem('nagoya_user', name);
            newExpense.value.payer = name;
            msgUser.value = name;
            shoppingModalData.value.owner = name;
        };
        
        const confirmLogout = () => { if(confirm("ÂàáÊèõ‰ΩøÁî®ËÄÖ?")) { currentUser.value = null; localStorage.removeItem('nagoya_user'); } };
        
        // Global Lock Logic
        const toggleGlobalLock = () => {
            if(db) set(dbRef(db, 'global_settings/is_locked'), !isLocked.value);
        };

        onMounted(() => {
            // 1. Load from LocalStorage FIRST (Offline Capability)
            try {
                if(localStorage.getItem('traffic')) trafficList.value = JSON.parse(localStorage.getItem('traffic'));
                if(localStorage.getItem('expenses')) expenses.value = JSON.parse(localStorage.getItem('expenses'));
                if(localStorage.getItem('messages')) messages.value = JSON.parse(localStorage.getItem('messages'));
                if(localStorage.getItem('locations')) locations.value = JSON.parse(localStorage.getItem('locations'));
                if(localStorage.getItem('shopping_list')) shoppingList.value = JSON.parse(localStorage.getItem('shopping_list'));
                if(localStorage.getItem('public_expenses')) publicExpenses.value = JSON.parse(localStorage.getItem('public_expenses'));
                if(localStorage.getItem('exchangeRate')) exchangeRate.value = parseFloat(localStorage.getItem('exchangeRate'));
                if(localStorage.getItem('public_fund_total')) publicFundTotal.value = parseFloat(localStorage.getItem('public_fund_total'));
            } catch(e) { console.error('Local Load Error', e); }

            const savedUser = localStorage.getItem('nagoya_user');
            if(savedUser && members.value.includes(savedUser)) setUser(savedUser);
            
            // 2. Then connect to Firebase (Sync)
            if(db) {
                let loadCheck = 0;
                const checkLoad = () => { loadCheck++; if(loadCheck >= 2) isLoading.value = false; };
                
                // ‰øÆÊ≠£: ÈÅ†Á´ØÊõ¥Êñ∞ÊôÇË®≠ÁΩÆ FlagÔºå‰∏¶ÈÄ≤Ë°åÂÖßÂÆπÊØîÂ∞çÈò≤Ê≠¢ Loop
                const handleRemoteUpdate = (refValue, targetRef) => {
                    const val = refValue || [];
                    if (JSON.stringify(targetRef.value) !== JSON.stringify(val)) {
                        isRemoteUpdate.value = true;
                        targetRef.value = val;
                        nextTick(() => { isRemoteUpdate.value = false; });
                    }
                };

                onValue(dbRef(db, 'traffic'), (s) => { handleRemoteUpdate(s.val(), trafficList); checkLoad(); });
                onValue(dbRef(db, 'expenses'), (s) => { handleRemoteUpdate(s.val(), expenses); checkLoad(); });
                onValue(dbRef(db, 'messages'), (s) => { handleRemoteUpdate(s.val(), messages); nextTick(() => { if (msgContainer.value) msgContainer.value.scrollTop = msgContainer.value.scrollHeight; }); });
                onValue(dbRef(db, 'locations'), (s) => { handleRemoteUpdate(s.val(), locations); });
                onValue(dbRef(db, 'shopping_list'), (s) => { handleRemoteUpdate(s.val(), shoppingList); });
                onValue(dbRef(db, 'public_expenses'), (s) => { handleRemoteUpdate(s.val(), publicExpenses); });
                
                onValue(dbRef(db, 'exchangeRate'), (s) => { if(s.val()) exchangeRate.value = parseFloat(s.val()); });
                onValue(dbRef(db, 'public_fund_total'), (s) => { if(s.val()) publicFundTotal.value = parseFloat(s.val()); });
                // Listen for Global Lock
                onValue(dbRef(db, 'global_settings/is_locked'), (s) => { isLocked.value = !!s.val(); });
            }

            // ‰øÆÊ≠£: Á¢∫‰øù Loading ‰∏çÊúÉÂç°Ê≠ªÔºåË®≠ÁΩÆ 5 ÁßíÂº∑Âà∂ÈóúÈñâ
            setTimeout(() => {
                if (isLoading.value) {
                    console.warn("Force clearing loading state");
                    isLoading.value = false;
                }
            }, 5000); 

            fetchRealTimeExchangeRate();
            fetchWeather();
        });

        // Watch and Sync to LocalStorage (Offline Persistence)
        // ‰øÆÊ≠£: Âä†ÂÖ• if (isRemoteUpdate.value) return; Èò≤Ê≠¢ÂØ´ÂÖ•Ëø¥Âúà
        const createWatcher = (source, storageKey, dbPath) => {
            watch(source, (v) => {
                if (isRemoteUpdate.value) return;
                localStorage.setItem(storageKey, JSON.stringify(v));
                if(db) set(dbRef(db, dbPath), v);
            }, { deep: true });
        };

        createWatcher(trafficList, 'traffic', 'traffic');
        createWatcher(expenses, 'expenses', 'expenses');
        createWatcher(messages, 'messages', 'messages');
        createWatcher(locations, 'locations', 'locations');
        createWatcher(shoppingList, 'shopping_list', 'shopping_list');
        createWatcher(publicExpenses, 'public_expenses', 'public_expenses');

        watch(exchangeRate, (v) => { localStorage.setItem('exchangeRate', v); if(db) set(dbRef(db, 'exchangeRate'), v); });
        watch(publicFundTotal, (v) => { localStorage.setItem('public_fund_total', v); });

        const filteredTraffic = computed(() => trafficList.value.filter(item => item.day === currentDay.value).sort((a, b) => a.time.localeCompare(b.time)));
        const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
        const calculatedTWD = computed(() => !newExpense.value.inputAmount ? 0 : (currencyMode.value === 'JPY' ? Math.round(newExpense.value.inputAmount * exchangeRate.value) : Math.round(newExpense.value.inputAmount)));
        
        // ‰øÆÊ≠£: isToday ÈÇèËºØÔºåË®àÁÆóÁï∂ÂâçÊó•ÊúüÊòØÁ¨¨ÂπæÂ§©
        const isToday = computed(() => {
            const today = getJapanDateObj();
            const diffTime = today - TRIP_START_DATE;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays === currentDay.value;
        }); 
        
        // Corrected for Japan Time (Timeline Position)
        const currentTimePercent = computed(() => {
            const japanDate = getJapanDateObj();
            const h = japanDate.getHours();
            const m = japanDate.getMinutes();
            // Assuming trip activity is roughly 6 AM to 12 PM (18 hours)
            const totalMinutes = 18 * 60;
            const currentMinutes = (h * 60 + m) - (6 * 60);
            const pct = (currentMinutes / totalMinutes) * 100;
            return Math.max(0, Math.min(100, pct));
        });

        const debts = computed(() => {
            if (members.value.length === 0) return [];
            let paid = {}; members.value.forEach(m => paid[m] = 0);
            expenses.value.forEach(e => { if (paid[e.payer] !== undefined) paid[e.payer] += e.amount; });
            const perPerson = totalExpense.value / members.value.length;
            let balance = members.value.map(m => ({ name: m, val: paid[m] - perPerson }));
            let result = []; balance.sort((a, b) => a.val - b.val); 
            let i = 0, j = balance.length - 1; 
            while (i < j) {
                let debtor = balance[i], creditor = balance[j];
                if (Math.abs(debtor.val) < 1) { i++; continue; }
                if (Math.abs(creditor.val) < 1) { j--; continue; }
                let amount = Math.min(Math.abs(debtor.val), creditor.val);
                if (amount > 1) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                debtor.val += amount; creditor.val -= amount;
                if (Math.abs(debtor.val) < 1) i++; if (creditor.val < 1) j--;
            }
            return result;
        });

        const payerExpenses = computed(() => !selectedPayerForDetail.value ? [] : expenses.value.filter(e => e.payer === selectedPayerForDetail.value).slice().reverse());
        const payerTotal = computed(() => payerExpenses.value.reduce((sum, item) => sum + item.amount, 0));
        const totalPublicSpent = computed(() => publicExpenses.value.reduce((sum, item) => sum + item.amount, 0));
        const remainingPublicFund = computed(() => publicFundTotal.value - totalPublicSpent.value);
        const publicFundPercentage = computed(() => publicFundTotal.value <= 0 ? 0 : Math.max(0, Math.min(100, (remainingPublicFund.value / publicFundTotal.value) * 100)));
        const filteredShoppingList = computed(() => !currentShoppingMember.value ? shoppingList.value : shoppingList.value.filter(item => item.owner === currentShoppingMember.value));
        const sortedShoppingList = computed(() => [...filteredShoppingList.value].sort((a, b) => (a.isBought === b.isBought) ? 0 : a.isBought ? 1 : -1));

        const askDelete = (type, id) => { confirmModal.value = { show: true, title: 'Delete Item?', message: 'Are you sure?', targetId: id, targetType: type }; };
        const confirmAction = () => {
            const { targetType, targetId } = confirmModal.value;
            if (targetType === 'traffic') trafficList.value = trafficList.value.filter(x => x.id !== targetId);
            else if (targetType === 'expense') expenses.value.splice(targetId, 1);
            else if (targetType === 'message') messages.value = messages.value.filter(m => m.id !== targetId);
            else if (targetType === 'location') locations.value = locations.value.filter(l => l.id !== targetId);
            else if (targetType === 'shopping') shoppingList.value = shoppingList.value.filter(l => l.id !== targetId);
            else if (targetType === 'publicExpense') publicExpenses.value = publicExpenses.value.filter(l => l.id !== targetId);
            confirmModal.value.show = false; showToast('Item deleted');
        };

        const handleExpenseImage = (event) => processImage(event.target.files[0], (d) => newExpense.value.image = d);
        // Added: Handle Public Image
        const handlePublicImage = (event) => processImage(event.target.files[0], (d) => newPublicExpense.value.image = d);
        const handleImageUpload = (event) => processImage(event.target.files[0], (d) => shoppingModalData.value.image = d);

        const openTrafficModal = () => { isEditingTraffic.value = false; editingTrafficId.value = null; trafficModalData.value = { time: '09:00', endTime: '', type: 'train', destination: '', description: '', url: '', ticketUrl: '' }; showTrafficModal.value = true; };
        const editTraffic = (item) => { isEditingTraffic.value = true; editingTrafficId.value = item.id; trafficModalData.value = { ...item }; showTrafficModal.value = true; };
        const copyTraffic = (item) => { const newItem = { ...item, id: Date.now() }; trafficList.value.push(newItem); showToast('Item copied'); };
        const saveTraffic = () => {
            if (!trafficModalData.value.destination) { showToast('Please enter destination', 'error'); return; }
            if (isEditingTraffic.value) { const idx = trafficList.value.findIndex(x => x.id === editingTrafficId.value); if (idx !== -1) trafficList.value[idx] = { ...trafficModalData.value, id: editingTrafficId.value, day: currentDay.value }; } 
            else trafficList.value.push({ id: Date.now(), day: currentDay.value, ...trafficModalData.value });
            showTrafficModal.value = false; showToast('Saved');
        };
        const getTransportIcon = (t) => ({ 'plane': 'fa-solid fa-plane', 'train': 'fa-solid fa-train', 'bus': 'fa-solid fa-bus', 'taxi': 'fa-solid fa-taxi', 'walk': 'fa-solid fa-person-walking' }[t] || 'fa-solid fa-diamond-turn-right');

        const addExpense = async () => {
            if (!newExpense.value.description || !newExpense.value.inputAmount || !newExpense.value.payer) { showToast('Missing info', 'error'); return; }
            // ‰øÆÊ≠£: Ë≤†Êï∏Ê™¢Êü•
            if (newExpense.value.inputAmount <= 0) { showToast('ÈáëÈ°çÈåØË™§', 'error'); return; }
            
            isLoading.value = true; // Show loading
            
            try {
                let imageUrl = '';
                if (newExpense.value.image) {
                     imageUrl = await uploadImageToStorage(newExpense.value.image, 'expenses');
                }

                // Use Japan Date
                expenses.value.push({ description: newExpense.value.description, originalAmount: newExpense.value.inputAmount, originalCurrency: currencyMode.value, amount: calculatedTWD.value, payer: newExpense.value.payer, date: getJapanDateStr(), image: imageUrl || '' });
                
                newExpense.value = { description: '', inputAmount: '', payer: currentUser.value || newExpense.value.payer, image: '' }; 
                showToast('Expense added');
            } catch(e) {
                console.error(e);
                showToast('Error', 'error');
            } finally {
                isLoading.value = false; // Hide loading
            }
        };
        
        // Updated Public Fund Logic (JPY/TWD)
        const updatePublicFund = () => { 
            if(!publicFundInput.value) return; 
            let amount = publicFundInput.value; 
            // If user selected JPY, convert to TWD for storage
            if(publicFundCurrencyMode.value === 'JPY') amount = Math.round(amount * exchangeRate.value); 
            set(dbRef(db, 'public_fund_total'), amount); 
            publicFundTotal.value = amount; 
            publicFundInput.value = ''; 
            showToast('Updated (Saved as TWD)'); 
        };
        
        // Updated Public Expense Logic (JPY/TWD) + Image
        const addPublicExpense = async () => {
            if(!newPublicExpense.value.name || !newPublicExpense.value.inputAmount) { showToast('Error', 'error'); return; }
            // ‰øÆÊ≠£: Ë≤†Êï∏Ê™¢Êü•
            if (newPublicExpense.value.inputAmount <= 0) { showToast('ÈáëÈ°çÈåØË™§', 'error'); return; }

            isLoading.value = true;

            try {
                let final = newPublicExpense.value.inputAmount; 
                // If JPY, convert to TWD
                if(newPublicExpense.value.currency === 'JPY') final = Math.round(final * exchangeRate.value);
                
                let imageUrl = '';
                if (newPublicExpense.value.image) {
                    imageUrl = await uploadImageToStorage(newPublicExpense.value.image, 'public_expenses');
                }

                publicExpenses.value.push({ 
                    id: Date.now(), 
                    name: newPublicExpense.value.name, 
                    amount: parseFloat(final), // Store as TWD
                    originalAmount: newPublicExpense.value.inputAmount, 
                    originalCurrency: newPublicExpense.value.currency, 
                    date: getJapanDateStr(), // Use Japan Date
                    image: imageUrl || '' // Include Image URL
                });
                newPublicExpense.value = { name: '', inputAmount: '', currency: 'JPY', image: '' }; 
                showToast('Added');
            } catch(e) {
                console.error(e);
                showToast('Error', 'error');
            } finally {
                isLoading.value = false;
            }
        };

        const sendMessage = () => { const user = currentUser.value || msgUser.value; if (!msgText.value.trim()) return; messages.value.push({ id: Date.now(), user: user, text: msgText.value, time: getJapanTimeStr() }); msgText.value = ''; };
        const openLocationModal = () => { isEditingLocation.value = false; locationModalData.value = { name: '', description: '', url: '' }; showLocationModal.value = true; };
        const editLocation = (loc) => { isEditingLocation.value = true; editingLocationId.value = loc.id; locationModalData.value = { ...loc }; showLocationModal.value = true; };
        const saveLocation = () => { if(!locationModalData.value.name) { showToast('Name required', 'error'); return; } if(isEditingLocation.value) { const idx = locations.value.findIndex(l => l.id === editingLocationId.value); if(idx !== -1) locations.value[idx] = { ...locationModalData.value, id: editingLocationId.value }; } else locations.value.push({ id: Date.now(), ...locationModalData.value }); showLocationModal.value = false; showToast('Saved'); };

        const toggleShoppingMember = (m) => currentShoppingMember.value = currentShoppingMember.value === m ? null : m;
        const openShoppingModal = () => { isEditingShopping.value = false; shoppingModalData.value = { name: '', description: '', image: '', owner: currentShoppingMember.value || currentUser.value || members.value[0], link: '', isBought: false }; showShoppingModal.value = true; };
        const editShopping = (item) => { isEditingShopping.value = true; editingShoppingId.value = item.id; shoppingModalData.value = { ...item }; showShoppingModal.value = true; };
        const toggleBought = (item) => { const idx = shoppingList.value.findIndex(l => l.id === item.id); if(idx !== -1) shoppingList.value[idx] = { ...item, isBought: !item.isBought }; };
        const saveShoppingItem = async () => { 
            if(!shoppingModalData.value.name) { showToast('Name required', 'error'); return; } 
            
            isLoading.value = true;

            try {
                let imageUrl = shoppingModalData.value.image;
                // Only upload if it's base64 (starts with data:)
                if (imageUrl && imageUrl.startsWith('data:')) {
                    imageUrl = await uploadImageToStorage(imageUrl, 'shopping');
                }

                const itemData = { ...shoppingModalData.value, image: imageUrl };

                if(isEditingShopping.value) { 
                    const idx = shoppingList.value.findIndex(l => l.id === editingShoppingId.value); 
                    if(idx !== -1) shoppingList.value[idx] = { ...itemData, id: editingShoppingId.value }; 
                } else { 
                    shoppingList.value.push({ id: Date.now(), ...itemData }); 
                }
                showShoppingModal.value = false; 
                showToast('Saved');
            } catch (e) {
                console.error(e);
                showToast('Error', 'error');
            } finally {
                isLoading.value = false;
            }
        };

        const fetchWeather = async () => { const coords = cityCoords[weatherCity.value]; if(!coords) return; try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`); const json = await res.json(); if(json && json.daily) weatherData.value = json; } catch(e) { console.warn('Weather fetch failed', e); } };
        const getWeatherDay = (idx) => { const d = new Date(); d.setDate(d.getDate() + idx); return ['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()]; };
        const getWeatherIcon = (c) => { if (c === 0) return 'fa-solid fa-sun'; if (c <= 3) return 'fa-solid fa-cloud-sun'; if (c <= 48) return 'fa-solid fa-smog'; if (c <= 67) return 'fa-solid fa-cloud-rain'; if (c <= 77) return 'fa-regular fa-snowflake'; if (c > 80 && c < 85) return 'fa-solid fa-cloud-showers-heavy'; if (c >= 85) return 'fa-solid fa-snowflake'; return 'fa-solid fa-cloud'; };

        const exportToCSV = () => {
            let csv = "data:text/csv;charset=utf-8,\uFEFFDate,Payer,Item,Amount(TWD)\n";
            expenses.value.forEach(r => csv += `${r.date},${r.payer},"${r.description}",${r.amount}\n`);
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "expenses.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        return {
            isLoading, currentUser, setUser, isLocked, confirmLogout, toggleGlobalLock,
            currentTab, tabNameMap, currentDay, days, members, expenses, newExpense, totalExpense, debts, addExpense, messages, msgText, msgUser, sendMessage, msgContainer, askDelete, confirmModal, confirmAction, exchangeRate, currencyMode, calculatedTWD, trafficList, filteredTraffic, showTrafficModal, trafficModalData, openTrafficModal, saveTraffic, editTraffic, copyTraffic, getTransportIcon, isEditingTraffic, toast, selectedPayerForDetail, payerExpenses, payerTotal, locations, showLocationModal, locationModalData, openLocationModal, editLocation, saveLocation, isEditingLocation, shoppingList, showShoppingModal, shoppingModalData, openShoppingModal, editShopping, saveShoppingItem, isEditingShopping, handleImageUpload, currentShoppingMember, toggleShoppingMember, filteredShoppingList, sortedShoppingList, toggleBought, weatherCity, weatherData, fetchWeather, getWeatherDay, getWeatherIcon, publicExpenses, publicFundTotal, publicFundInput, publicFundCurrencyMode, newPublicExpense, updatePublicFund, addPublicExpense, totalPublicSpent, remainingPublicFund, publicFundPercentage, handlePublicImage, handleExpenseImage, showImageModal, viewImageSrc, openImageModal, exportToCSV,
            isToday, currentTimePercent
        };
    }
}).mount('#app');
</script>
</body>
</html>
